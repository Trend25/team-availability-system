<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Availability System v4.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;
            text-align: center; padding: 30px; position: relative; }
        .cloud-status { position: absolute; top: 10px; left: 20px; background: rgba(255,255,255,0.2);
            padding: 8px 12px; border-radius: 20px; font-size: .8rem; display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #4CAF50; animation: pulse 2s infinite; }
        .status-dot.error { background: #f44336; } .status-dot.loading { background: #ff9800; }
        @keyframes pulse { 0%{opacity:1} 50%{opacity:.5} 100%{opacity:1} }
        .language-selector { position: absolute; top: 20px; right: 20px; display:flex; gap:5px; background: rgba(255,255,255,.2); border-radius:20px; padding:2px; }
        .lang-btn { padding:8px 16px; border:none; background:transparent; color:white; cursor:pointer; border-radius:18px; font-weight:600; transition:.3s; }
        .lang-btn.active { background:white; color:#4facfe; }
        .tabs { display:flex; background:#f8f9fa; border-bottom:1px solid #dee2e6; overflow-x:auto; }
        .tab { flex:1; min-width:120px; padding:15px 20px; cursor:pointer; text-align:center; font-weight:600; transition:.3s; background:#f8f9fa; border:none; }
        .tab.active { background:white; color:#4facfe; border-bottom:3px solid #4facfe; }
        .tab:disabled { opacity:.5; cursor:not-allowed; }
        .content { padding:30px; min-height:600px; }
        .setup-section { background:#fff3cd; border:1px solid #ffeaa7; color:#856404; padding:20px; border-radius:8px; margin-bottom:20px; }
        .form-section { background:#f8f9fa; padding:25px; border-radius:10px; margin-bottom:20px; border-left:4px solid #4facfe; }
        .form-group { margin-bottom:20px; }
        .form-group label { display:block; margin-bottom:8px; font-weight:600; color:#495057; }
        .form-group input, .form-group select, .form-group textarea {
            width:100%; padding:12px 15px; border:2px solid #dee2e6; border-radius:8px; font-size:1rem; transition:border-color .3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline:none; border-color:#4facfe; box-shadow:0 0 0 3px rgba(79,172,254,.1);
        }
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
        .form-row-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; }
        .btn { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color:white; padding:12px 25px;
            border:none; border-radius:8px; cursor:pointer; font-size:1rem; font-weight:600; transition:.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow:0 8px 25px rgba(79,172,254,.3); }
        .btn:disabled { background:#6c757d; cursor:not-allowed; transform:none; }
        .btn-success { background: linear-gradient(135deg,#28a745 0%, #20c997 100%); }
        .btn-danger { background: linear-gradient(135deg,#dc3545 0%, #c82333 100%); }
        .btn-secondary { background:#6c757d; }
        .btn-small { padding:8px 15px; font-size:.9rem; }
        .success-message { background:#d4edda; color:#155724; padding:15px; border-radius:8px; border:1px solid #c3e6cb; margin:15px 0; }
        .error-message { background:#f8d7da; color:#721c24; padding:15px; border-radius:8px; border:1px solid #f5c6cb; margin:15px 0; }
        .user-card { background:white; border:2px solid #e9ecef; border-radius:10px; padding:20px; margin:15px 0; display:grid; grid-template-columns:1fr auto; align-items:center; gap:20px; }
        .user-actions { display:flex; gap:10px; flex-wrap:wrap; }
        .empty-state { text-align:center; color:#6c757d; padding:40px; font-size:1.1rem; }
        .month-selector { background:white; padding:20px; border-radius:10px; margin-bottom:20px; border:2px solid #e9ecef; display:flex; align-items:center; gap:15px; flex-wrap:wrap; }
        .month-grid { display:grid; grid-template-columns:repeat(7,1fr); border:1px solid #dee2e6; border-radius:10px; overflow:hidden; }
        .day-header { background:#f8f9fa; padding:10px; text-align:center; font-weight:600; border-bottom:1px solid #dee2e6; }
        .day-cell { min-height:80px; padding:8px; border-right:1px solid #dee2e6; border-bottom:1px solid #dee2e6; cursor:pointer; transition:.2s; user-select:none; }
        .day-cell.weekend { background:#f8f9fa; color:#6c757d; cursor:not-allowed; }
        .day-cell.available { background:#d4edda; }
        .day-cell.unavailable { background:#e2e3e5; }
        .day-cell:hover:not(.weekend):not(.other-month) { background:#fff3cd; }
        .day-cell.other-month { background:#f8f9fa; opacity:.3; }
        .day-number { font-weight:600; margin-bottom:5px; }
        .time-display { font-size:.7rem; color:#495057; text-align:center; }
        .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color: rgba(0,0,0,.5); }
        .modal.active { display:flex; align-items:center; justify-content:center; }
        .modal-content { background:white; padding:30px; border-radius:15px; width:90%; max-width:600px; box-shadow:0 20px 40px rgba(0,0,0,.3); max-height:80vh; overflow-y:auto; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #e9ecef; }
        .close { font-size:28px; font-weight:bold; cursor:pointer; color:#adb5bd; }
        .time-grid { display:grid; grid-template-columns: repeat(4,1fr); gap:8px; margin:15px 0; }
        .time-slot-btn { padding:10px; border:2px solid #dee2e6; border-radius:6px; background:white; cursor:pointer; transition:.2s; text-align:center; font-weight:600; font-size:.9rem; }
        .time-slot-btn:hover { background:#e7f3ff; border-color:#4facfe; }
        .time-slot-btn.selected { background:#4facfe; color:white; border-color:#4facfe; }
        .selected-time-info { background:#e7f3ff; padding:15px; border-radius:8px; margin:15px 0; border-left:4px solid #2196f3; }
        @media (max-width:768px){
            .form-row, .form-row-3{ grid-template-columns:1fr; }
            .user-card{ grid-template-columns:1fr; }
            .cloud-status, .language-selector { position:static; margin-bottom:15px; justify-content:center; }
            .time-grid{ grid-template-columns: repeat(3,1fr); }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="cloud-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="connectionStatus">Initializing...</span>
        </div>
        <div class="language-selector">
            <button class="lang-btn active" onclick="switchLanguage('tr')">TR</button>
            <button class="lang-btn" onclick="switchLanguage('en')">EN</button>
        </div>
        <h1 data-i18n="title">Team Availability System</h1>
        <p data-i18n="subtitle">Cloud-based team availability tracker v4.0</p>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('setup')" id="setupTab" data-i18n="tab_setup">Kurulum</button>
        <button class="tab" onclick="showTab('login')" id="loginTab" disabled data-i18n="tab_login">Giriş</button>
        <button class="tab" onclick="showTab('admin')" id="adminTab" disabled style="display:none;" data-i18n="tab_admin">Admin</button>
        <button class="tab" onclick="showTab('availability')" id="availabilityTab" disabled data-i18n="tab_availability">Müsaitlik</button>
        <button class="tab" onclick="showTab('calendar')" id="calendarTab" disabled data-i18n="tab_calendar">Ekip Takvimi</button>
        <button class="tab" onclick="showTab('meeting')" id="meetingTab" disabled data-i18n="tab_meeting">Toplantı Planla</button>
        <button class="tab" onclick="showTab('settings')" id="settingsTab" disabled style="display:none;" data-i18n="tab_settings">Ayarlar</button>
    </div>

    <div class="content">
        <!-- SETUP TAB -->
        <div id="setup" class="tab-content active">
            <div class="setup-section">
                <h3 data-i18n="setup_title">GitHub Repository Setup</h3>
                <p data-i18n="setup_desc">This system uses GitHub repository as cloud database - completely free and reliable.</p>
            </div>

            <div class="form-section">
                <h3 data-i18n="setup_step1">Step 1: Create GitHub Repository</h3>
                <ol style="margin-left:20px; line-height:1.8;">
                    <li>Go to <a href="https://github.com" target="_blank">github.com</a></li>
                    <li>Click "New repository"</li>
                    <li>Repository name: <code>team-availability-data</code></li>
                    <li>Select "Public"</li>
                    <li>Check "Add a README file"</li>
                    <li>Click "Create repository"</li>
                </ol>
            </div>

            <div class="form-section">
                <h3 data-i18n="setup_step2">Step 2: GitHub Personal Access Token</h3>
                <ol style="margin-left:20px; line-height:1.8;">
                    <li>Settings → Developer settings → Personal access tokens → Tokens (classic)</li>
                    <li>"Generate new token" (classic)</li>
                    <li>Note: "Team Availability System"</li>
                    <li>Scopes: Check "repo"</li>
                    <li>Generate token and COPY IT</li>
                </ol>
            </div>

            <div class="form-section">
                <h3 data-i18n="setup_step3">Step 3: System Configuration</h3>
                <div class="form-group">
                    <label for="githubUsername" data-i18n="github_username_label">GitHub Username:</label>
                    <input type="text" id="githubUsername" placeholder="your-username" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="githubRepo" data-i18n="github_repo_label">Repository Name:</label>
                    <input type="text" id="githubRepo" value="team-availability-data" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="githubToken" data-i18n="github_token_label">GitHub Token:</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="new-password">
                </div>
                <button class="btn" onclick="testGitHubConnection()" data-i18n="test_connection_btn">Test Connection</button>
                <div id="setupMessage"></div>
            </div>

            <div class="form-section" id="adminSetupSection" style="display:none;">
                <h3 data-i18n="setup_step4">Step 4: Create Admin Account</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="initialAdminEmail">Admin Email:</label>
                        <input type="email" id="initialAdminEmail" placeholder="admin@company.com" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="initialAdminPassword">Admin Password:</label>
                        <input type="password" id="initialAdminPassword" placeholder="Strong password" autocomplete="new-password">
                    </div>
                </div>
                <div class="form-group">
                    <label for="companyName" data-i18n="company_name_label">Company Name:</label>
                    <input type="text" id="companyName" placeholder="Acme Corporation" autocomplete="off">
                </div>
                <button class="btn btn-success" onclick="createInitialAdmin()" data-i18n="start_system_btn">Start System</button>
            </div>
        </div>

        <!-- LOGIN TAB -->
        <div id="login" class="tab-content" style="display:none;">
            <div class="form-section">
                <h3 data-i18n="login_title">User Login</h3>
                <div class="form-group">
                    <label for="loginEmail" data-i18n="email_label">Email:</label>
                    <input type="email" id="loginEmail" placeholder="user@company.com" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="loginPassword" data-i18n="password_label">Password:</label>
                    <input type="password" id="loginPassword" autocomplete="new-password">
                </div>
                <button class="btn" onclick="loginUser()" data-i18n="login_btn">Login</button>
                <div id="loginMessage"></div>
            </div>
        </div>

        <!-- ADMIN TAB -->
        <div id="admin" class="tab-content" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 data-i18n="admin_panel_title">Admin Panel</h2>
                <button class="btn btn-secondary" onclick="logout()" data-i18n="logout_btn">Logout</button>
            </div>

            <div class="form-section">
                <h3 data-i18n="add_user_title">Add New User</h3>
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="newUserName" data-i18n="name_label">Name:</label>
                        <input type="text" id="newUserName" placeholder="John Doe" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="newUserEmail" data-i18n="email_label">Email:</label>
                        <input type="email" id="newUserEmail" placeholder="john@company.com" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="newUserRole" data-i18n="role_label">Role:</label>
                        <input type="text" id="newUserRole" placeholder="Developer" autocomplete="off">
                    </div>
                </div>
                <button class="btn" onclick="addNewUser()" data-i18n="add_user_btn">Add User</button>
                <div id="adminMessage"></div>
            </div>

            <div class="form-section">
                <h3 data-i18n="users_list_title">Current Users</h3>
                <div id="usersList" class="empty-state" data-i18n="no_users">No users yet</div>
            </div>
        </div>

        <!-- AVAILABILITY TAB -->
        <div id="availability" class="tab-content" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="availabilityWelcome">Welcome!</h2>
                <button class="btn btn-secondary" onclick="logout()" data-i18n="logout_btn">Logout</button>
            </div>

            <div class="month-selector">
                <label data-i18n="month_select_label">Select Month:</label>
                <select id="monthSelect"></select>
                <button class="btn" onclick="loadCalendar()" data-i18n="load_calendar_btn">Load Calendar</button>
            </div>

            <div id="memberCalendar"></div>

            <div style="margin-top:20px;">
                <button class="btn btn-success" onclick="saveAvailability()" data-i18n="save_availability_btn">Save All</button>
            </div>

            <div id="availabilityMessage"></div>
        </div>

        <!-- TEAM CALENDAR TAB -->
        <div id="calendar" class="tab-content" style="display:none;">
            <h2 data-i18n="team_calendar_title">Team Calendar - Who is Available When</h2>
            <div class="month-selector">
                <label data-i18n="month_select_label">Select Month:</label>
                <select id="teamMonthSelect"></select>
                <button class="btn" onclick="loadTeamCalendar()" data-i18n="load_calendar_btn">Load Calendar</button>
            </div>
            <div id="teamCalendarView" class="empty-state" data-i18n="team_calendar_empty">Select a month to view team availability</div>
        </div>

        <!-- MEETING PLANNER TAB -->
        <div id="meeting" class="tab-content" style="display:none;">
            <h2 data-i18n="meeting_planner_title">Meeting Planner</h2>
            <div class="form-section">
                <h3 data-i18n="find_common_time">Find Common Available Time</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="meetingMonth" data-i18n="month_select_label">Select Month:</label>
                        <select id="meetingMonth"></select>
                    </div>
                    <div class="form-group">
                        <label for="meetingDuration" data-i18n="duration_label">Duration (hours):</label>
                        <input type="number" id="meetingDuration" value="1" min="0.5" step="0.5" max="8">
                    </div>
                </div>

                <div class="form-group">
                    <label data-i18n="select_participants">Select Participants:</label>
                    <div id="participantsList" style="background:#f8f9fa; padding:15px; border-radius:8px; margin-top:10px;"></div>
                </div>

                <button class="btn" onclick="findCommonTimes()" data-i18n="find_times_btn">Find Available Times</button>
                <div id="meetingResults"></div>
            </div>

            <div id="googleMeetSection" style="display:none;">
                <div class="form-section">
                    <h3 data-i18n="create_meeting_title">Create Google Meet</h3>
                    <div class="form-group">
                        <label for="meetingTitle" data-i18n="meeting_title_label">Meeting Title:</label>
                        <input type="text" id="meetingTitle" placeholder="Weekly Team Meeting">
                    </div>
                    <div class="form-group">
                        <label for="meetingDescription" data-i18n="meeting_description_label">Description:</label>
                        <textarea id="meetingDescription" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="selectedMeetingDate" data-i18n="selected_date_label">Selected Date:</label>
                            <input type="date" id="selectedMeetingDate" readonly style="background:#e9ecef;">
                        </div>
                        <div class="form-group">
                            <label for="selectedMeetingTime" data-i18n="selected_time_label">Selected Time:</label>
                            <input type="time" id="selectedMeetingTime" readonly style="background:#e9ecef;">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="createGoogleMeet()" data-i18n="create_google_meet_btn">Create Google Calendar Event</button>
                </div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings" class="tab-content" style="display:none;">
            <h2 data-i18n="settings_title">System Settings</h2>
            <div class="form-section">
                <h3 data-i18n="github_config_title">GitHub Configuration</h3>
                <p style="color:#856404; background:#fff3cd; padding:10px; border-radius:6px; margin-bottom:15px;">
                    <strong>⚠️ Warning:</strong> Changing these settings will affect all users. Only modify if you're changing the data repository.
                </p>
                <div class="form-group">
                    <label for="settingsGithubUsername" data-i18n="github_username_label">GitHub Username:</label>
                    <input type="text" id="settingsGithubUsername" placeholder="your-username" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="settingsGithubRepo" data-i18n="github_repo_label">Repository Name:</label>
                    <input type="text" id="settingsGithubRepo" placeholder="team-availability-data" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="settingsGithubToken" data-i18n="github_token_label">GitHub Token:</label>
                    <input type="password" id="settingsGithubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="new-password">
                </div>
                <button class="btn" onclick="updateGitHubConfig()" data-i18n="update_config_btn">Update Configuration</button>
                <div id="settingsMessage"></div>
            </div>

            <div class="form-section">
                <h3 data-i18n="change_admin_password_title">Change Admin Password</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="currentAdminPassword" data-i18n="current_password_label">Current Password:</label>
                        <input type="password" id="currentAdminPassword" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label for="newAdminPassword" data-i18n="new_password_label">New Password:</label>
                        <input type="password" id="newAdminPassword" autocomplete="new-password">
                    </div>
                </div>
                <button class="btn" onclick="changeAdminPassword()" data-i18n="change_password_btn">Change Password</button>
                <div id="passwordMessage"></div>
            </div>
        </div>
    </div>
</div>

<!-- Availability Modal -->
<div id="availabilityModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Set Availability</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div>
            <div class="form-group">
                <label data-i18n="availability_status_label">Status:</label>
                <select id="availabilityStatus" onchange="toggleTimeSelection()">
                    <option value="available" data-i18n="available_option">Available</option>
                    <option value="unavailable" data-i18n="unavailable_option">Not Available</option>
                </select>
            </div>

            <div id="timeSelection">
                <div class="selected-time-info">
                    <strong data-i18n="selected_time_label">Selected:</strong> <span id="selectedTimeDisplay">-</span>
                </div>
                <div>
                    <h4 data-i18n="start_time_title">Start Time:</h4>
                    <div class="time-grid" id="startTimeGrid"></div>
                </div>
                <div style="margin-top:20px;">
                    <h4 data-i18n="end_time_title">End Time:</h4>
                    <div class="time-grid" id="endTimeGrid"></div>
                </div>
            </div>

            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn" onclick="saveModalAvailability()" data-i18n="save_btn">Save</button>
                <button class="btn btn-secondary" onclick="closeModal()" data-i18n="cancel_btn">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
// === Translations ===
const translations = {
    tr: {
        title:'Takım Müsaitlik Sistemi',
        subtitle:'Bulut tabanlı takım müsaitlik takipçisi v4.0',
        tab_setup:'Kurulum', tab_login:'Giriş', tab_admin:'Admin', tab_availability:'Müsaitlik',
        tab_calendar:'Ekip Takvimi', tab_meeting:'Toplantı Planla', tab_settings:'Ayarlar',
        setup_title:'GitHub Deposu Kurulumu', setup_desc:'Bu sistem veri deposu olarak GitHub kullanır. Ücretsiz ve güvenilirdir.',
        setup_step1:'Adım 1: GitHub Deposu Oluştur', setup_step2:'Adım 2: Kişisel Erişim Anahtarı', setup_step3:'Adım 3: Sistem Yapılandırması',
        setup_step4:'Adım 4: Admin Hesabı Oluştur', test_connection_btn:'Bağlantıyı Test Et',
        github_username_label:'GitHub Kullanıcı Adı:', github_repo_label:'Depo Adı:', github_token_label:'GitHub Token:',
        company_name_label:'Şirket Adı:', start_system_btn:'Sistemi Başlat',
        login_title:'Kullanıcı Girişi', email_label:'Email:', password_label:'Şifre:', login_btn:'Giriş Yap',
        admin_panel_title:'Yönetim Paneli', logout_btn:'Çıkış', add_user_title:'Yeni Kullanıcı Ekle',
        name_label:'İsim:', role_label:'Rol:', add_user_btn:'Kullanıcı Ekle', users_list_title:'Mevcut Kullanıcılar', no_users:'Henüz kullanıcı yok',
        month_select_label:'Ay Seç:', load_calendar_btn:'Takvimi Yükle', save_availability_btn:'Tümünü Kaydet',
        team_calendar_title:'Ekip Takvimi - Kim Ne Zaman Müsait', team_calendar_empty:'Ekip müsaitliğini görmek için ay seçiniz',
        meeting_planner_title:'Toplantı Planlayıcı', find_common_time:'Ortak Müsait Zaman Bul',
        duration_label:'Süre (saat):', select_participants:'Katılımcıları Seç:', find_times_btn:'Müsait Saatleri Bul',
        create_meeting_title:'Google Meet Oluştur', meeting_title_label:'Toplantı Başlığı:', meeting_description_label:'Açıklama:',
        selected_date_label:'Seçilen Tarih:', selected_time_label:'Seçilen Saat:', create_google_meet_btn:'Google Calendar Etkinliği Oluştur',
        settings_title:'Sistem Ayarları', github_config_title:'GitHub Yapılandırması', update_config_btn:'Yapılandırmayı Güncelle',
        change_admin_password_title:'Admin Şifresini Değiştir', current_password_label:'Mevcut Şifre:', new_password_label:'Yeni Şifre:', change_password_btn:'Şifreyi Değiştir',
        availability_status_label:'Durum:', available_option:'Müsait', unavailable_option:'Müsait Değil',
        selected_time_label:'Seçilen', start_time_title:'Başlangıç Saati:', end_time_title:'Bitiş Saati:',
        save_btn:'Kaydet', cancel_btn:'İptal',
        days:['Pzt','Sal','Çar','Per','Cum','Cmt','Paz'],
        months:['Ocak','Şubat','Mart','Nisan','Mayıs','Haziran','Temmuz','Ağustos','Eylül','Ekim','Kasım','Aralık']
    },
    en: {
        title:'Team Availability System',
        subtitle:'Cloud-based team availability tracker v4.0',
        tab_setup:'Setup', tab_login:'Login', tab_admin:'Admin', tab_availability:'Availability',
        tab_calendar:'Team Calendar', tab_meeting:'Plan Meeting', tab_settings:'Settings',
        setup_title:'GitHub Repository Setup', setup_desc:'This system uses GitHub as a cloud database - free & reliable.',
        setup_step1:'Step 1: Create GitHub Repository', setup_step2:'Step 2: Personal Access Token', setup_step3:'Step 3: System Configuration',
        setup_step4:'Step 4: Create Admin Account', test_connection_btn:'Test Connection',
        github_username_label:'GitHub Username:', github_repo_label:'Repository Name:', github_token_label:'GitHub Token:',
        company_name_label:'Company Name:', start_system_btn:'Start System',
        login_title:'User Login', email_label:'Email:', password_label:'Password:', login_btn:'Login',
        admin_panel_title:'Admin Panel', logout_btn:'Logout', add_user_title:'Add New User',
        name_label:'Name:', role_label:'Role:', add_user_btn:'Add User', users_list_title:'Current Users', no_users:'No users yet',
        month_select_label:'Select Month:', load_calendar_btn:'Load Calendar', save_availability_btn:'Save All',
        team_calendar_title:'Team Calendar - Who is Available When', team_calendar_empty:'Select a month to view team availability',
        meeting_planner_title:'Meeting Planner', find_common_time:'Find Common Available Time',
        duration_label:'Duration (hours):', select_participants:'Select Participants:', find_times_btn:'Find Available Times',
        create_meeting_title:'Create Google Meet', meeting_title_label:'Meeting Title:', meeting_description_label:'Description:',
        selected_date_label:'Selected Date:', selected_time_label:'Selected Time:', create_google_meet_btn:'Create Google Calendar Event',
        settings_title:'System Settings', github_config_title:'GitHub Configuration', update_config_btn:'Update Configuration',
        change_admin_password_title:'Change Admin Password', current_password_label:'Current Password:', new_password_label:'New Password:', change_password_btn:'Change Password',
        availability_status_label:'Status:', available_option:'Available', unavailable_option:'Not Available',
        selected_time_label:'Selected', start_time_title:'Start Time:', end_time_title:'End Time:',
        save_btn:'Save', cancel_btn:'Cancel',
        days:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
        months:['January','February','March','April','May','June','July','August','September','October','November','December']
    }
};

let currentLang='tr';
let githubConfig={ username:'', repo:'', token:'', isConfigured:false };
let systemData={ users:{}, availability:{}, config:{} };
let currentUser=null;
let currentEditingDate=null;
let selectedStartTime=null;
let selectedEndTime=null;

// === SESSION MANAGEMENT (localStorage) ===
function saveSession(){
    localStorage.setItem('teamAvailGithubConfig', JSON.stringify(githubConfig));
    localStorage.setItem('teamAvailCurrentUser', JSON.stringify(currentUser));
    localStorage.setItem('teamAvailLang', currentLang);
}
function loadSession(){
    const savedConfig = localStorage.getItem('teamAvailGithubConfig');
    const savedUser = localStorage.getItem('teamAvailCurrentUser');
    const savedLang = localStorage.getItem('teamAvailLang');
    
    if(savedConfig){
        githubConfig = JSON.parse(savedConfig);
        if(githubConfig.isConfigured){
            document.getElementById('setupTab').style.display='none';
            document.getElementById('loginTab').disabled=false;
            updateStatus('connected','Configured');
        }
    }
    
    if(savedUser){
        currentUser = JSON.parse(savedUser);
        restoreUserSession();
    }
    
    if(savedLang){
        currentLang = savedLang;
        document.querySelectorAll('.lang-btn').forEach(btn=>{
            btn.classList.toggle('active', btn.textContent.toLowerCase()===currentLang);
        });
        updateTranslations();
    }
}
function clearSession(){
    localStorage.removeItem('teamAvailGithubConfig');
    localStorage.removeItem('teamAvailCurrentUser');
    currentUser = null;
    githubConfig = { username:'', repo:'', token:'', isConfigured:false };
}

// Password hashing
async function hashPassword(password){
    const encoder=new TextEncoder();
    const data=encoder.encode(password);
    const hashBuffer=await crypto.subtle.digest('SHA-256', data);
    const hashArray=Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b=>b.toString(16).padStart(2,'0')).join('');
}

// Language
function switchLanguage(lang){
    currentLang=lang;
    localStorage.setItem('teamAvailLang', lang);
    document.querySelectorAll('.lang-btn').forEach(btn=>btn.classList.remove('active'));
    event.target.classList.add('active');
    updateTranslations();
    if(currentUser && document.getElementById('memberCalendar').innerHTML) loadCalendar();
}
function updateTranslations(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key=el.getAttribute('data-i18n');
        if(translations[currentLang][key]) el.textContent=translations[currentLang][key];
    });
}

// Tab management
function showTab(tabName){
    document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(tabName).style.display='block';
    document.getElementById(tabName+'Tab').classList.add('active');
    
    // Load participants list when switching to meeting tab
    if(tabName==='meeting' && currentUser){
        loadParticipantsList();
    }
    
    // Refresh team calendar if switching to it
    if(tabName==='calendar' && currentUser){
        const monthValue = document.getElementById('teamMonthSelect')?.value;
        if(monthValue) loadTeamCalendar();
    }
}

// Status updates
function updateStatus(type,message){
    const dot=document.getElementById('statusDot');
    const status=document.getElementById('connectionStatus');
    dot.className=`status-dot ${type}`;
    status.textContent=message;
}
function showMessage(elementId,message,type){
    const element=document.getElementById(elementId);
    element.innerHTML=`<div class="${type}-message">${message}</div>`;
    setTimeout(()=>{ element.innerHTML=''; },5000);
}

// GitHub API helpers
async function githubApiCall(endpoint,method='GET',data=null){
    if(!githubConfig.isConfigured) throw new Error('GitHub not configured');
    const url=`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${endpoint}`;
    const options={ method, headers:{
        'Authorization':`token ${githubConfig.token}`,
        'Accept':'application/vnd.github.v3+json',
        'Content-Type':'application/json'
    }};
    if(data) options.body=JSON.stringify(data);
    const response=await fetch(url, options);
    if(!response.ok){
        throw new Error(`GitHub API Error: ${response.status}`);
    }
    return await response.json();
}
async function saveDataToGitHub(filename,data){
    const content=btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2))));
    let sha=null;
    try{ const existing=await githubApiCall(filename); sha=existing.sha; }catch(_){}
    const payload={ message:`Update ${filename}`, content };
    if(sha) payload.sha=sha;
    await githubApiCall(filename,'PUT',payload);
    return true;
}
async function loadDataFromGitHub(filename){
    try{
        const response=await githubApiCall(filename);
        const content=decodeURIComponent(escape(atob(response.content)));
        return JSON.parse(content);
    }catch(_){ return {}; }
}

// Setup
async function testGitHubConnection(){
    const username=document.getElementById('githubUsername').value.trim();
    const repo=document.getElementById('githubRepo').value.trim();
    const token=document.getElementById('githubToken').value.trim();
    if(!username||!repo||!token){ showMessage('setupMessage','Fill all fields!','error'); return; }
    updateStatus('loading','Testing...');
    try{
        githubConfig={ username, repo, token, isConfigured:true };
        await githubApiCall('');
        systemData=await loadDataFromGitHub('team-data.json');
        if(!systemData.users) systemData.users={};
        if(!systemData.availability) systemData.availability={};
        if(!systemData.config) systemData.config={};
        
        updateStatus('connected','Connected');
        showMessage('setupMessage','GitHub connection successful!','success');
        document.getElementById('adminSetupSection').style.display='block';
        document.getElementById('loginTab').disabled=false;
        saveSession();
    }catch(error){
        updateStatus('error','Failed');
        showMessage('setupMessage','Connection error: '+error.message,'error');
        githubConfig.isConfigured=false;
    }
}
async function createInitialAdmin(){
    const email=document.getElementById('initialAdminEmail').value.trim().toLowerCase();
    const password=document.getElementById('initialAdminPassword').value;
    const company=document.getElementById('companyName').value.trim();
    
    if(!email||!password||!company||password.length<8){
        showMessage('setupMessage','Fill all fields! Password min 8 chars.','error'); return;
    }
    
    // Check if admin with this email already exists
    const existingUsers = Object.values(systemData.users || {});
    if(existingUsers.some(u=>u.email.toLowerCase()===email)){
        showMessage('setupMessage','Admin with this email already exists!','error'); return;
    }
    
    try{
        const hashedPassword=await hashPassword(password);
        systemData.config={ company, initialized:true, createdAt:new Date().toISOString() };
        systemData.users[Date.now()]={ 
            name:'Administrator', 
            email, 
            passwordHash:hashedPassword, 
            role:'Admin', 
            isAdmin:true, 
            createdAt:new Date().toISOString() 
        };
        await saveDataToGitHub('team-data.json',systemData);
        showMessage('setupMessage','System initialized! You can login now.','success');
        document.getElementById('setupTab').style.display='none';
        showTab('login');
    }catch(error){ showMessage('setupMessage','Setup error: '+error.message,'error'); }
}

// Login
async function loginUser(){
    const email=document.getElementById('loginEmail').value.trim().toLowerCase();
    const password=document.getElementById('loginPassword').value;
    if(!email||!password){ showMessage('loginMessage','Email and password required!','error'); return; }
    try{
        updateStatus('loading','Checking...');
        systemData=await loadDataFromGitHub('team-data.json');
        
        const hashedPassword=await hashPassword(password);
        const users=Object.entries(systemData.users||{});
        const userEntry=users.find(([id,u])=>u.email.toLowerCase()===email && u.passwordHash===hashedPassword);
        
        if(userEntry){
            const [userId, user] = userEntry;
            currentUser={...user, userId}; // Store userId with user object
            
            updateStatus('connected','Logged in');
            document.getElementById('loginEmail').value='';
            document.getElementById('loginPassword').value='';
            
            document.getElementById('availabilityTab').disabled=false;
            document.getElementById('calendarTab').disabled=false;
            document.getElementById('meetingTab').disabled=false;
            
            if(user.isAdmin){
                document.getElementById('adminTab').style.display='block';
                document.getElementById('settingsTab').style.display='block';
                document.getElementById('settingsTab').disabled=false;
                loadSettingsForm();
                showTab('admin');
                loadUsersList();
            }else{
                showTab('availability');
                initializeAvailability();
            }
            
            populateMonthOptions();
            saveSession();
            showMessage('loginMessage',`Welcome, ${user.name}!`,'success');
        }else{
            showMessage('loginMessage','Invalid credentials!','error');
            updateStatus('error','Login failed');
        }
    }catch(error){
        showMessage('loginMessage','Login error: '+error.message,'error');
        updateStatus('error','Error');
    }
}

function restoreUserSession(){
    if(!currentUser) return;
    
    updateStatus('connected','Logged in');
    document.getElementById('availabilityTab').disabled=false;
    document.getElementById('calendarTab').disabled=false;
    document.getElementById('meetingTab').disabled=false;
    
    if(currentUser.isAdmin){
        document.getElementById('adminTab').style.display='block';
        document.getElementById('settingsTab').style.display='block';
        document.getElementById('settingsTab').disabled=false;
        loadSettingsForm();
        showTab('admin');
        loadUsersList();
    }else{
        showTab('availability');
        initializeAvailability();
    }
    
    populateMonthOptions();
}

function logout(){
    clearSession();
    document.getElementById('loginTab').disabled=false;
    document.getElementById('availabilityTab').disabled=true;
    document.getElementById('calendarTab').disabled=true;
    document.getElementById('meetingTab').disabled=true;
    document.getElementById('adminTab').style.display='none';
    document.getElementById('settingsTab').style.display='none';
    updateStatus('connected','Logged out');
    showTab('login');
}

// Admin functions
async function addNewUser(){
    const name=document.getElementById('newUserName').value.trim();
    const email=document.getElementById('newUserEmail').value.trim().toLowerCase();
    const role=document.getElementById('newUserRole').value.trim();
    
    if(!name||!email||!role){ 
        showMessage('adminMessage','Fill all fields!','error'); 
        return; 
    }
    
    // Reload latest data
    systemData=await loadDataFromGitHub('team-data.json');
    
    // Check if email already exists
    const existingUsers=Object.values(systemData.users||{});
    if(existingUsers.some(u=>u.email.toLowerCase()===email)){ 
        showMessage('adminMessage','Email already exists!','error'); 
        return; 
    }
    
    try{
        const password=generatePassword();
        const hashedPassword=await hashPassword(password);
        const userId=Date.now();
        systemData.users[userId]={ 
            name,
            email,
            passwordHash:hashedPassword,
            role,
            isAdmin:false,
            createdAt:new Date().toISOString() 
        };
        await saveDataToGitHub('team-data.json',systemData);
        
        alert(`User added!\n\nName: ${name}\nEmail: ${email}\nPassword: ${password}\n\nShare these credentials securely.`);
        
        document.getElementById('newUserName').value='';
        document.getElementById('newUserEmail').value='';
        document.getElementById('newUserRole').value='';
        
        await loadUsersList();
        showMessage('adminMessage','User added successfully!','success');
    }catch(error){ 
        showMessage('adminMessage','Error: '+error.message,'error'); 
    }
}

function generatePassword(){
    const chars='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
    let password=''; 
    for(let i=0;i<12;i++) password+=chars.charAt(Math.floor(Math.random()*chars.length));
    return password;
}

async function loadUsersList(){
    const usersList=document.getElementById('usersList');
    try{
        systemData=await loadDataFromGitHub('team-data.json');
        const users=Object.entries(systemData.users||{});
        
        if(users.length===0){ 
            usersList.innerHTML='<div class="empty-state">No users yet</div>'; 
            return; 
        }
        
        usersList.innerHTML=users.map(([id,user])=>`
            <div class="user-card">
                <div>
                    <h4>${user.name} ${user.isAdmin ? '(Admin)' : ''}</h4>
                    <div style="color:#666;">${user.email} | ${user.role}</div>
                </div>
                <div class="user-actions">
                    <button class="btn btn-small" onclick="resetPassword('${id}')">Reset Password</button>
                    ${!user.isAdmin ? `<button class="btn btn-small btn-danger" onclick="deleteUser('${id}')">Delete</button>` : ''}
                </div>
            </div>
        `).join('');
    }catch(_){ 
        usersList.innerHTML='<div class="error-message">Error loading users</div>'; 
    }
}

async function resetPassword(userId){
    try{
        systemData=await loadDataFromGitHub('team-data.json');
        const newPassword=generatePassword();
        const hashedPassword=await hashPassword(newPassword);
        systemData.users[userId].passwordHash=hashedPassword;
        await saveDataToGitHub('team-data.json',systemData);
        const user=systemData.users[userId];
        alert(`Password reset!\n\nUser: ${user.name}\nEmail: ${user.email}\nNew Password: ${newPassword}`);
    }catch(error){ 
        showMessage('adminMessage','Error: '+error.message,'error'); 
    }
}

async function deleteUser(userId){
    if(confirm('Delete this user? This cannot be undone.')){
        try{
            systemData=await loadDataFromGitHub('team-data.json');
            delete systemData.users[userId];
            if(systemData.availability[userId]) delete systemData.availability[userId];
            await saveDataToGitHub('team-data.json',systemData);
            await loadUsersList();
            showMessage('adminMessage','User deleted successfully!','success');
        }catch(error){ 
            showMessage('adminMessage','Delete error: '+error.message,'error'); 
        }
    }
}

// Availability
function initializeAvailability(){
    document.getElementById('availabilityWelcome').textContent=`Welcome, ${currentUser.name}!`;
    populateMonthOptions();
    // Auto-load current month
    if(document.getElementById('monthSelect').value) loadCalendar();
}

function populateMonthOptions(){
    const monthSelect=document.getElementById('monthSelect');
    const teamMonthSelect=document.getElementById('teamMonthSelect');
    const meetingMonth=document.getElementById('meetingMonth');
    const options=[];
    
    for(let i=0;i<6;i++){
        const date=new Date(); 
        date.setMonth(date.getMonth()+i);
        const value=`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
        const text=`${translations[currentLang].months[date.getMonth()]} ${date.getFullYear()}`;
        options.push({value,text});
    }
    
    const html=options.map(o=>`<option value="${o.value}">${o.text}</option>`).join('');
    if(monthSelect) monthSelect.innerHTML=html;
    if(teamMonthSelect) teamMonthSelect.innerHTML=html;
    if(meetingMonth) meetingMonth.innerHTML=html;
}

async function loadCalendar(){
    const monthValue=document.getElementById('monthSelect').value;
    const [year,month]=monthValue.split('-').map(Number);
    
    // Reload data to get latest availability
    systemData=await loadDataFromGitHub('team-data.json');
    
    const html=generateCalendar(year,month);
    document.getElementById('memberCalendar').innerHTML=html;
}

function generateCalendar(year,month){
    const firstDay=new Date(year,month-1,1);
    const lastDay=new Date(year,month,0);
    const daysInMonth=lastDay.getDate();
    const startDay=(firstDay.getDay()+6)%7;
    const monthName=translations[currentLang].months[month-1];
    const dayNames=translations[currentLang].days;
    
    let html=`<div style="background:#4facfe;color:white;padding:15px;text-align:center;font-size:1.2rem;font-weight:600;border-radius:10px 10px 0 0;">${monthName} ${year}</div><div class="month-grid">`;
    dayNames.forEach(day=>html+=`<div class="day-header">${day}</div>`);
    
    for(let i=0;i<startDay;i++){ 
        html+='<div class="day-cell other-month"></div>'; 
    }
    
    const userId=currentUser.userId;
    
    for(let day=1; day<=daysInMonth; day++){
        const date=new Date(year,month-1,day);
        const dateString=date.toISOString().split('T')[0];
        const dow=date.getDay();
        const isWeekend=dow===0 || dow===6;
        
        let cellClass='day-cell'; 
        let timeDisplay='';
        
        if(isWeekend){ 
            cellClass+=' weekend'; 
        }else{
            const dayData=systemData.availability[userId]?.[dateString];
            if(dayData){
                cellClass+=dayData.available?' available':' unavailable';
                if(dayData.available && dayData.start && dayData.end){
                    timeDisplay=`<div class="time-display">${dayData.start}-${dayData.end}</div>`;
                }
            }
        }
        
        const clickAction=isWeekend?'':`onclick="openModal('${dateString}')"`;
        html+=`<div class="${cellClass}" ${clickAction}><div class="day-number">${day}</div>${timeDisplay}</div>`;
    }
    
    html+='</div>';
    return html;
}

function openModal(dateString){
    currentEditingDate=dateString;
    const date=new Date(dateString);
    const formatted=date.toLocaleDateString(currentLang==='tr'?'tr-TR':'en-US',{ 
        weekday:'long', year:'numeric', month:'long', day:'numeric' 
    });
    document.getElementById('modalTitle').textContent=formatted;
    
    const userId=currentUser.userId;
    const dayData=systemData.availability[userId]?.[dateString];
    
    if(dayData){ 
        document.getElementById('availabilityStatus').value=dayData.available?'available':'unavailable';
        selectedStartTime=dayData.start||'09:00'; 
        selectedEndTime=dayData.end||'17:00';
    }else{ 
        document.getElementById('availabilityStatus').value='available'; 
        selectedStartTime='09:00'; 
        selectedEndTime='17:00'; 
    }
    
    generateTimeSlots(); 
    updateSelectedTimeDisplay(); 
    toggleTimeSelection();
    document.getElementById('availabilityModal').classList.add('active');
}

function toggleTimeSelection(){
    const status=document.getElementById('availabilityStatus').value;
    document.getElementById('timeSelection').style.display=status==='available'?'block':'none';
}

function generateTimeSlots(){
    const times=[];
    for(let h=0;h<24;h++){ 
        for(let m=0;m<60;m+=30){ 
            times.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`); 
        } 
    }
    const workHourTimes=times.slice(18,40); // 09:00 - 19:30
    
    document.getElementById('startTimeGrid').innerHTML=workHourTimes.map(t=>
        `<div class="time-slot-btn ${t===selectedStartTime?'selected':''}" onclick="selectStartTime('${t}')">${t}</div>`
    ).join('');
    
    document.getElementById('endTimeGrid').innerHTML=workHourTimes.map(t=>
        `<div class="time-slot-btn ${t===selectedEndTime?'selected':''}" onclick="selectEndTime('${t}')">${t}</div>`
    ).join('');
}

function selectStartTime(time){ 
    selectedStartTime=time; 
    generateTimeSlots(); 
    updateSelectedTimeDisplay(); 
}

function selectEndTime(time){ 
    selectedEndTime=time; 
    generateTimeSlots(); 
    updateSelectedTimeDisplay(); 
}

function updateSelectedTimeDisplay(){ 
    document.getElementById('selectedTimeDisplay').textContent=`${selectedStartTime} - ${selectedEndTime}`; 
}

function closeModal(){ 
    document.getElementById('availabilityModal').classList.remove('active'); 
}

async function saveModalAvailability(){
    if(!currentEditingDate || !currentUser) return;
    
    const isAvailable=document.getElementById('availabilityStatus').value==='available';
    const userId=currentUser.userId;
    
    if(!systemData.availability[userId]) systemData.availability[userId]={};
    
    systemData.availability[userId][currentEditingDate]={ 
        available:isAvailable, 
        start:isAvailable?selectedStartTime:null, 
        end:isAvailable?selectedEndTime:null 
    };
    
    closeModal(); 
    loadCalendar(); 
    showMessage('availabilityMessage','Availability saved for this day! Click "Save All" to sync to cloud.','success');
}

async function saveAvailability(){
    try{ 
        updateStatus('loading','Saving...'); 
        await saveDataToGitHub('team-data.json',systemData);
        updateStatus('connected','Saved'); 
        showMessage('availabilityMessage','All availability saved successfully!','success');
    }catch(error){ 
        updateStatus('error','Save failed'); 
        showMessage('availabilityMessage','Save error: '+error.message,'error'); 
    }
}

// Team Calendar - NEVER SHOW ADMIN USERS
async function loadTeamCalendar(){
    const monthValue=document.getElementById('teamMonthSelect').value;
    const [year,month]=monthValue.split('-').map(Number);
    
    systemData=await loadDataFromGitHub('team-data.json');
    
    // EXCLUDE admin users - critical rule
    const users=Object.entries(systemData.users||{}).filter(([_,u])=>!u.isAdmin);
    
    if(users.length===0){
        document.getElementById('teamCalendarView').innerHTML='<div class="empty-state">No non-admin users found</div>'; 
        return;
    }
    
    const lastDay=new Date(year,month,0); 
    const daysInMonth=lastDay.getDate();
    const monthName=translations[currentLang].months[month-1];
    
    let html=`
    <div style="overflow-x:auto;">
        <div style="background:#4facfe;color:white;padding:15px;text-align:center;font-size:1.3rem;font-weight:600;margin-bottom:20px;border-radius:10px;">
            ${monthName} ${year} - Team Availability
        </div>
        <table style="width:100%; border-collapse:collapse; min-width:1000px;">
            <thead>
                <tr style="background:#4facfe; color:white;">
                    <th style="padding:15px; text-align:left; position:sticky; left:0; background:#4facfe; z-index:10;">Team Member</th>`;
    
    for(let day=1; day<=daysInMonth; day++){
        const date=new Date(year,month-1,day);
        const dow=date.getDay();
        if(dow>=1 && dow<=5){
            const dayName=translations[currentLang].days[dow===0?6:dow-1];
            html+=`<th style="padding:10px; text-align:center; font-size:.85rem; min-width:80px;">${day}<br>${dayName}</th>`;
        }
    }
    html+='</tr></thead><tbody>';
    
    users.forEach(([userId,user])=>{
        html+=`<tr>
            <td style="padding:15px; border:1px solid #dee2e6; font-weight:600; position:sticky; left:0; background:white; z-index:5;">
                ${user.name}<br><small style="color:#666; font-weight:normal;">${user.role||''}</small>
            </td>`;
        
        for(let day=1; day<=daysInMonth; day++){
            const date=new Date(year,month-1,day);
            const dow=date.getDay();
            if(dow>=1 && dow<=5){
                const dateString=date.toISOString().split('T')[0];
                const dayData=systemData.availability[userId]?.[dateString];
                let bg='#fff3cd'; 
                let content='?'; 
                let title='Not set';
                
                if(dayData){
                    if(dayData.available){ 
                        bg='#d4edda'; 
                        content=`<div style="font-size:.75rem; font-weight:600;">✓</div><div style="font-size:.7rem;">${dayData.start}-${dayData.end}</div>`; 
                        title=`Available: ${dayData.start}-${dayData.end}`; 
                    }else{ 
                        bg='#e2e3e5'; 
                        content='✗'; 
                        title='Not available'; 
                    }
                }
                html+=`<td style="padding:8px; text-align:center; background:${bg}; border:1px solid #dee2e6;" title="${title}">${content}</td>`;
            }
        }
        html+='</tr>';
    });
    
    html+='</tbody></table></div>';
    document.getElementById('teamCalendarView').innerHTML=html;
}

// Meeting Planner - Load participants immediately
async function loadParticipantsList(){
    systemData=await loadDataFromGitHub('team-data.json');
    
    // EXCLUDE admin users - critical rule
    const users=Object.entries(systemData.users||{}).filter(([id,user])=>!user.isAdmin);
    
    if(users.length===0){
        document.getElementById('participantsList').innerHTML='<div class="empty-state">No participants available</div>';
        return;
    }
    
    const html=users.map(([userId,user])=>`
        <label style="display:block; padding:10px; cursor:pointer; border-radius:6px; margin-bottom:5px; background:white;">
            <input type="checkbox" value="${userId}" style="margin-right:10px; width:auto;">
            ${user.name} ${user.role ? '('+user.role+')' : ''}
        </label>
    `).join('');
    
    document.getElementById('participantsList').innerHTML=html;
}

async function findCommonTimes(){
    const monthValue=document.getElementById('meetingMonth').value;
    const [year,month]=monthValue.split('-').map(Number);
    const duration=parseFloat(document.getElementById('meetingDuration').value);
    
    systemData=await loadDataFromGitHub('team-data.json');
    
    const checkboxes=document.querySelectorAll('#participantsList input[type="checkbox"]:checked');
    const selectedUserIds=Array.from(checkboxes).map(cb=>cb.value);
    
    if(selectedUserIds.length<2){
        document.getElementById('meetingResults').innerHTML='<div class="error-message">Please select at least 2 participants</div>'; 
        return;
    }
    
    const lastDay=new Date(year,month,0); 
    const daysInMonth=lastDay.getDate();
    const commonTimes=[];
    
    for(let day=1; day<=daysInMonth; day++){
        const date=new Date(year,month-1,day);
        const dow=date.getDay();
        
        if(dow>=1 && dow<=5){
            const dateString=date.toISOString().split('T')[0];
            
            const allAvailable=selectedUserIds.every(uid=>{
                const dayData=systemData.availability[uid]?.[dateString];
                return dayData && dayData.available;
            });
            
            if(allAvailable){
                const timeSlots=selectedUserIds.map(uid=>{
                    const dayData=systemData.availability[uid][dateString];
                    return { 
                        userId:uid, 
                        start:dayData.start, 
                        end:dayData.end, 
                        userName: systemData.users[uid].name 
                    };
                });
                
                const latestStart=timeSlots.reduce((latest,slot)=> 
                    slot.start>latest?slot.start:latest, timeSlots[0].start);
                const earliestEnd=timeSlots.reduce((earliest,slot)=> 
                    slot.end<earliest?slot.end:earliest, timeSlots[0].end);
                
                const startMin=parseInt(latestStart.split(':')[0])*60 + parseInt(latestStart.split(':')[1]);
                const endMin=parseInt(earliestEnd.split(':')[0])*60 + parseInt(earliestEnd.split(':')[1]);
                const availHours=(endMin-startMin)/60;
                
                if(availHours>=duration){
                    commonTimes.push({
                        date:dateString,
                        dateFormatted: date.toLocaleDateString(currentLang==='tr'?'tr-TR':'en-US',{ 
                            weekday:'long', year:'numeric', month:'long', day:'numeric' 
                        }),
                        start:latestStart, 
                        end:earliestEnd, 
                        duration:availHours, 
                        participants:timeSlots
                    });
                }
            }
        }
    }
    
    if(commonTimes.length===0){
        document.getElementById('meetingResults').innerHTML='<div class="error-message">No common available times found for selected participants in this month.</div>'; 
        return;
    }
    
    let html = `<div class="success-message" style="margin-top:20px;"><strong>Found ${commonTimes.length} common available time(s)</strong></div><div style="margin-top:20px;">`;
    
    commonTimes.forEach(slot=>{
        html+=`
        <div style="background:#d4edda; border:2px solid #28a745; border-radius:10px; padding:20px; margin:15px 0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div>
                    <h4 style="color:#155724; margin-bottom:5px;">📅 ${slot.dateFormatted}</h4>
                    <div style="font-size:1.1rem; font-weight:600; color:#155724;">⏰ ${slot.start} - ${slot.end} (${slot.duration.toFixed(1)}h available)</div>
                </div>
                <button class="btn btn-success" onclick="selectMeetingSlot('${slot.date}', '${slot.start}')">Select This Time</button>
            </div>
            <div style="margin-top:10px;">
                <strong>Participants:</strong><br>
                ${slot.participants.map(p=>`<span style="display:inline-block; background:white; padding:5px 10px; border-radius:15px; margin:3px;">👤 ${p.userName}</span>`).join('')}
            </div>
        </div>`;
    });
    
    html+='</div>';
    document.getElementById('meetingResults').innerHTML=html;
}

function selectMeetingSlot(date,time){
    document.getElementById('selectedMeetingDate').value=date;
    document.getElementById('selectedMeetingTime').value=time;
    document.getElementById('googleMeetSection').style.display='block';
    document.getElementById('googleMeetSection').scrollIntoView({ behavior:'smooth' });
}

function createGoogleMeet(){
    const title=document.getElementById('meetingTitle').value || 'Team Meeting';
    const description=document.getElementById('meetingDescription').value || '';
    const date=document.getElementById('selectedMeetingDate').value;
    const time=document.getElementById('selectedMeetingTime').value;
    const duration=parseFloat(document.getElementById('meetingDuration').value) || 1;
    
    if(!date || !time){ 
        alert('Please select a meeting slot first!'); 
        return; 
    }
    
    const startDate=new Date(date+'T'+time);
    const endDate=new Date(startDate.getTime()+duration*60*60*1000);
    
    const formatGoogleDate=(d)=> d.toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
    
    const checkboxes=document.querySelectorAll('#participantsList input[type="checkbox"]:checked');
    const selectedUserIds=Array.from(checkboxes).map(cb=>cb.value);
    const participantEmails=selectedUserIds.map(id=>systemData.users[id].email).join(',');
    
    const googleCalendarUrl=`https://calendar.google.com/calendar/render?action=TEMPLATE`
        + `&text=${encodeURIComponent(title)}`
        + `&dates=${formatGoogleDate(startDate)}/${formatGoogleDate(endDate)}`
        + `&details=${encodeURIComponent(description + '\n\nGoogle Meet: Will be auto-generated when you save this event')}`
        + `&add=${encodeURIComponent(participantEmails)}`
        + `&ctz=Europe/Istanbul`;
    
    window.open(googleCalendarUrl,'_blank');
    alert('Google Calendar event opened in new window!\n\n1. Click "Add Google Meet"\n2. Save the event');
}

// Settings
function loadSettingsForm(){
    document.getElementById('settingsGithubUsername').value=githubConfig.username||'';
    document.getElementById('settingsGithubRepo').value=githubConfig.repo||'';
    document.getElementById('settingsGithubToken').value=githubConfig.token||'';
}

async function updateGitHubConfig(){
    const username=document.getElementById('settingsGithubUsername').value.trim();
    const repo=document.getElementById('settingsGithubRepo').value.trim();
    const token=document.getElementById('settingsGithubToken').value.trim();
    
    if(!username||!repo||!token){ 
        showMessage('settingsMessage','All fields required!','error'); 
        return; 
    }
    
    updateStatus('loading','Testing new config...');
    
    try{
        const testConfig={ username, repo, token, isConfigured:true };
        const oldConfig={...githubConfig};
        githubConfig=testConfig;
        
        await githubApiCall('');
        
        updateStatus('connected','Config updated');
        showMessage('settingsMessage','GitHub configuration updated successfully!','success');
        saveSession();
    }catch(error){
        updateStatus('error','Config failed');
        showMessage('settingsMessage','Configuration test failed: '+error.message,'error');
    }
}

async function changeAdminPassword(){
    const currentPassword=document.getElementById('currentAdminPassword').value;
    const newPassword=document.getElementById('newAdminPassword').value;
    
    if(!currentPassword||!newPassword||newPassword.length<8){
        showMessage('passwordMessage','Fill all fields! New password min 8 chars.','error');
        return;
    }
    
    try{
        systemData=await loadDataFromGitHub('team-data.json');
        const currentHash=await hashPassword(currentPassword);
        
        if(currentUser.passwordHash !== currentHash){
            showMessage('passwordMessage','Current password is incorrect!','error');
            return;
        }
        
        const newHash=await hashPassword(newPassword);
        systemData.users[currentUser.userId].passwordHash=newHash;
        currentUser.passwordHash=newHash;
        
        await saveDataToGitHub('team-data.json',systemData);
        saveSession();
        
        showMessage('passwordMessage','Password changed successfully!','success');
        document.getElementById('currentAdminPassword').value='';
        document.getElementById('newAdminPassword').value='';
    }catch(error){
        showMessage('passwordMessage','Error: '+error.message,'error');
    }
}

// Initialize on page load
window.addEventListener('DOMContentLoaded', ()=>{
    loadSession();
    updateTranslations();
    
    if(!githubConfig.isConfigured){
        updateStatus('error','Not configured');
    }
});
</script>
</body>
</html>
