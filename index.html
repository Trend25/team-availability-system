<script>
// =========================
// GLOBAL STATE
// =========================
let DB = { users: {}, availability: {} };
let ME = null;
let SELECTED_DAYS = new Set();
let START_TIME = '09:00';
let END_TIME   = '17:00';

// =========================
// TIMEZONE HELPERS
// - Noon-key: gün anahtarını 12:00'a sabitler (00:00 yerine)
// - UTC saklama, yerelde gösterim
// =========================
const VIEWER_TZ = Intl.DateTimeFormat().resolvedOptions().timeZone;

// Yerel "YYYY-MM-DD" metninden UTC gün anahtarı üret (ÖĞLEN 12:00)
function toUTCDateKeyFromLocalStr(localYYYYMMDD) {
  return new Date(`${localYYYYMMDD}T12:00:00`).toISOString().split('T')[0];
}
// Date objesinden UTC gün anahtarı (ÖĞLEN 12:00)
function toUTCDateKey(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth()+1).padStart(2,'0');
  const d = String(date.getDate()).padStart(2,'0');
  return new Date(`${y}-${m}-${d}T12:00:00`).toISOString().split('T')[0];
}

// =========================
// UTILITY UI HELPERS
// =========================
function setStatus(txt, color='#333') {
  const el = document.getElementById('status');
  if (el) { el.textContent = txt; el.style.background = color; }
}
function showMsg(id, txt, type='info') {
  const host = document.getElementById(id);
  if (!host) return;
  host.innerHTML = `<div class="msg ${type}">${txt}</div>`;
  setTimeout(() => { if (host.innerHTML.includes(txt)) host.innerHTML=''; }, 4000);
}
function showTab(name) {
  document.querySelectorAll('.tab-content').forEach(el => el.style.display='none');
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  const tab = document.getElementById(name);
  if (tab) tab.style.display='block';
  const btn = document.getElementById('tab-'+name);
  if (btn) btn.classList.add('active');
  if (name === 'meeting' && typeof loadParticipants === 'function') loadParticipants();
}

// =========================
// PERSISTENCE (Fallback’lı)
// - Projende loadDB/saveDB zaten varsa, onları kullanır
// - Yoksa localStorage fallback devreye girer
// =========================
async function __fallbackLoadDB() {
  try {
    const raw = localStorage.getItem('TEAMAVAS_DB');
    DB = raw ? JSON.parse(raw) : { users:{}, availability:{} };
  } catch(e) {
    DB = { users:{}, availability:{} };
  }
}
async function __fallbackSaveDB() {
  localStorage.setItem('TEAMAVAS_DB', JSON.stringify(DB));
}

// Eğer projende tanımlı değilse fallback bağla
if (typeof loadDB !== 'function')  window.loadDB  = __fallbackLoadDB;
if (typeof saveDB !== 'function')  window.saveDB  = __fallbackSaveDB;

// =========================
// QUICK ACTIONS (tek tıkla çevirme)
// =========================
function quickSetAvailability(status) {
  const sel = document.getElementById('avail-status');
  if (sel) sel.value = status;

  if (SELECTED_DAYS.size === 0) {
    showMsg('avail-msg', 'Önce en az bir iş günü seçin', 'error');
    return;
  }
  if (status === 'yes') {
    if (!START_TIME || !END_TIME) {
      showMsg('avail-msg', 'Saat aralığını seçin', 'error');
      return;
    }
    if (START_TIME >= END_TIME) {
      showMsg('avail-msg', 'Başlangıç, bitişten önce olmalı', 'error');
      return;
    }
  }
  saveMyAvailability(); // merkezi kayıt
}

// =========================
// AVAILABILITY SAVE (UTC STORE + NOON KEY)
// =========================
async function saveMyAvailability() {
  if (SELECTED_DAYS.size === 0) {
    showMsg('avail-msg', 'Select at least one day', 'error');
    return;
  }

  await loadDB();
  const status = document.getElementById('avail-status')?.value || 'no';
  if (!ME || !ME.id) {
    // konuk kullanıcı için mock
    ME = ME || { id: 'me', name: 'Me', admin: false };
    DB.users[ME.id] = DB.users[ME.id] || { name: 'Me', email:'me@example.com' };
  }
  if (!DB.availability[ME.id]) DB.availability[ME.id] = {};

  SELECTED_DAYS.forEach(dateStrLocal => {
    const dateKeyUTC = toUTCDateKeyFromLocalStr(dateStrLocal);

    let startUTC = null, endUTC = null, start = null, end = null;
    if (status === 'yes') {
      const startLocal = new Date(`${dateStrLocal}T${START_TIME}:00`);
      const endLocal   = new Date(`${dateStrLocal}T${END_TIME}:00`);
      startUTC = startLocal.toISOString();
      endUTC   = endLocal.toISOString();
      start = START_TIME; end = END_TIME; // geriye dönük uyumluluk etiketi
    }

    DB.availability[ME.id][dateKeyUTC] = {
      status,
      start, end,            // legacy labels
      startUTC, endUTC,      // canonical UTC
      tz: VIEWER_TZ
    };
  });

  try {
    setStatus('Saving...', '#ff9800');
    await saveDB();
    setStatus('Saved!', '#4CAF50');
    showMsg('avail-msg', `Saved ${SELECTED_DAYS.size} days!`, 'success');
    if (typeof renderMyCalendar === 'function') renderMyCalendar();
    if (typeof renderTeamCalendar === 'function') renderTeamCalendar();
  } catch (e) {
    showMsg('avail-msg', 'Error: ' + e.message, 'error');
    setStatus('Save Failed', '#f44336');
  }
}

// =========================
// MY CALENDAR (yerel gösterim)
// =========================
async function renderMyCalendar() {
  await loadDB();

  const val = document.getElementById('avail-month')?.value;
  if (!val) return;
  const [year, month] = val.split('-').map(Number);
  const firstDay = new Date(year, month - 1, 1);
  const lastDay  = new Date(year, month, 0);
  const daysInMonth = lastDay.getDate();
  const startDow = (firstDay.getDay() + 6) % 7; // Mon=0

  const myAvail = DB.availability[ME?.id || 'me'] || {};

  let html = '<div class="cal-grid">';
  ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(day => {
    html += `<div style="font-weight:bold;padding:10px;text-align:center;">${day}</div>`;
  });

  // boş hücreler
  for (let i=0;i<startDow;i++) html += `<div></div>`;

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month - 1, d);
    const dow = date.getDay();
    const isWeekend = (dow === 0 || dow === 6);

    const dateStrLocal = date.toISOString().split('T')[0];
    const dateKeyUTC   = toUTCDateKeyFromLocalStr(dateStrLocal);

    let cls = 'cal-day';
    let extra = '';

    if (isWeekend) {
      cls += ' weekend';
    } else {
      const av = myAvail[dateKeyUTC];
      if (av) {
        cls += ' has-data';
        const startLabel = av.startUTC ? new Date(av.startUTC).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : (av.start || '');
        const endLabel   = av.endUTC   ? new Date(av.endUTC).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})   : (av.end || '');
        extra = av.status === 'yes' ? `<small>${startLabel}-${endLabel}</small>` : '<small>Not Available</small>';
      }
    }

    html += `<div class="${cls}" data-date="${dateStrLocal}" onclick="toggleDaySelection('${dateStrLocal}', ${isWeekend})">
      <div class="cal-day-num">${d}</div>
      ${extra}
    </div>`;
  }

  html += '</div>';
  const host = document.getElementById('my-calendar');
  if (host) host.innerHTML = html;
}

// Seçim toggler (mevcut CSS/HTML ile uyumlu)
function toggleDaySelection(dateStr, isWeekend) {
  if (isWeekend) return;
  const dayEl = document.querySelector(`.cal-day[data-date="${dateStr}"]`);
  if (!dayEl) return;

  if (SELECTED_DAYS.has(dateStr)) {
    SELECTED_DAYS.delete(dateStr);
    dayEl.classList.remove('selected');
  } else {
    SELECTED_DAYS.add(dateStr);
    dayEl.classList.add('selected');
  }
}

// =========================
// TEAM CALENDAR (yerel gösterim + noon-key)
// =========================
async function renderTeamCalendar() {
  await loadDB();
  const val = document.getElementById('team-month')?.value;
  if (!val) return;
  const [year, month] = val.split('-').map(Number);
  const lastDay = new Date(year, month, 0);
  const daysInMonth = lastDay.getDate();

  const users = Object.entries(DB.users).filter(([id,u]) => !u.admin);
  if (users.length === 0) {
    const host = document.getElementById('team-calendar');
    if (host) host.innerHTML = '<p>No users found</p>';
    return;
  }

  let html = '<table><thead><tr><th>User</th>';
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month - 1, d);
    if (date.getDay() >= 1 && date.getDay() <= 5) {
      html += `<th>${d}</th>`;
    }
  }
  html += '</tr></thead><tbody>';

  for (const [id, u] of users) {
    const userAvail = DB.availability[id] || {};
    html += `<tr><td>${u.name || id}</td>`;
    for (let d = 1; d <= daysInMonth; d++) {
      const date = new Date(year, month - 1, d);
      if (date.getDay() >= 1 && date.getDay() <= 5) {
        const dateStrLocal = date.toISOString().split('T')[0];
        const dateKeyUTC   = toUTCDateKeyFromLocalStr(dateStrLocal);
        const av = userAvail[dateKeyUTC];

        let cls = 'avail-unknown', txt = '-';
        if (av) {
          cls = av.status === 'yes' ? 'avail-yes' : 'avail-no';
          const startLabel = av.startUTC ? new Date(av.startUTC).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : (av.start || '');
          const endLabel   = av.endUTC   ? new Date(av.endUTC).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})   : (av.end || '');
          txt = av.status === 'yes' ? `✓<br><small>${startLabel}-${endLabel}</small>` : '✗';
        }
        html += `<td class="${cls}">${txt}</td>`;
      }
    }
    html += '</tr>';
  }

  html += '</tbody></table>';
  const host = document.getElementById('team-calendar');
  if (host) host.innerHTML = html;
}

// =========================
// MEETING PLANNER (UTC ISO ile kesişim)
// =========================
async function findMeetingTimes() {
  await loadDB();
  const val = document.getElementById('meeting-month')?.value;
  const duration = parseFloat(document.getElementById('meeting-duration')?.value || '1');
  if (!val) return;
  const [year, month] = val.split('-').map(Number);

  const selectedIds = Array.from(document.querySelectorAll('#participants input:checked')).map(cb => cb.value);
  if (selectedIds.length < 2) {
    showMsg('meeting-results', 'Select at least 2 participants', 'error');
    return;
  }

  const lastDay = new Date(year, month, 0);
  const commonSlots = [];

  for (let d = 1; d <= lastDay.getDate(); d++) {
    const date = new Date(year, month - 1, d);
    if (date.getDay() >= 1 && date.getDay() <= 5) {
      const dateStrLocal = date.toISOString().split('T')[0];
      const dateKeyUTC   = toUTCDateKeyFromLocalStr(dateStrLocal);

      const allAvail = selectedIds.every(id => DB.availability[id]?.[dateKeyUTC]?.status === 'yes');

      if (allAvail) {
        const slots = selectedIds.map(id => {
          const av = DB.availability[id][dateKeyUTC];
          return {
            id,
            startISO: av.startUTC || (av.start ? new Date(`${dateKeyUTC}T${av.start}:00Z`).toISOString() : null),
            endISO:   av.endUTC   || (av.end   ? new Date(`${dateKeyUTC}T${av.end}:00Z`).toISOString()   : null),
            name: DB.users[id]?.name || id
          };
        });

        const latestStartISO  = slots.reduce((max, s) => (!max || (s.startISO && s.startISO > max)) ? s.startISO : max, null);
        const earliestEndISO  = slots.reduce((min, s) => (!min || (s.endISO && s.endISO < min)) ? s.endISO : min, null);
        const startMs = Date.parse(latestStartISO);
        const endMs   = Date.parse(earliestEndISO);
        const availHours = (endMs - startMs) / 3600000;

        if (availHours >= duration) {
          commonSlots.push({
            date: dateKeyUTC,
            formatted: new Date(latestStartISO).toLocaleDateString('tr-TR', { weekday:'long', month:'long', day:'numeric' }),
            startISO: latestStartISO,
            endISO: earliestEndISO,
            start: new Date(latestStartISO).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            end:   new Date(earliestEndISO).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            duration: availHours,
            participants: slots
          });
        }
      }
    }
  }

  if (commonSlots.length === 0) {
    showMsg('meeting-results', 'No common slots found', 'error');
    return;
  }

  let html = '';
  commonSlots.forEach(slot => {
    html += `<div class="section" style="background:#d4edda;border-color:#28a745;">
      <h4>${slot.formatted}</h4>
      <p><strong>Time:</strong> ${slot.start} - ${slot.end} (${slot.duration.toFixed(1)}h)</p>
      <p><strong>Participants:</strong> ${slot.participants.map(p => p.name).join(', ')}</p>
      <button class="btn" onclick="createGoogleMeetISO('${slot.startISO}','${slot.endISO}','${slot.participants.map(p => p.id).join(',')}')">Create Google Meet</button>
    </div>`;
  });
  document.getElementById('meeting-results').innerHTML = html;
}

// =========================
/** Google Calendar linkini ISO ile üretir */
function createGoogleMeetISO(startISO, endISO, participantIds) {
  const participantEmails = participantIds.split(',').map(id => DB.users[id]?.email || '').filter(Boolean).join(',');
  const fmt = (iso) => iso.replace(/[-:]/g, '').split('.')[0] + 'Z';
  const url = `https://calendar.google.com/calendar/render?action=TEMPLATE`
    + `&text=${encodeURIComponent('Team Meeting')}`
    + `&dates=${fmt(startISO)}/${fmt(endISO)}`
    + `&details=${encodeURIComponent('Scheduled via Team Availability System')}`
    + `&add=${encodeURIComponent(participantEmails)}`;
  window.open(url, '_blank');
  alert('Google Calendar opened!\\n\\n1. Click "Add Google Meet"\\n2. Save event');
}
// =========================

// (İsteğe bağlı) başlangıçta gerekli çağrılar
document.addEventListener('DOMContentLoaded', async () => {
  try {
    setStatus('Connecting...', '#607d8b');
    await loadDB();
    // ME yoksa mock kullanıcı oluştur
    if (!ME || !ME.id) {
      const stored = localStorage.getItem('TEAMAVAS_ME');
      ME = stored ? JSON.parse(stored) : { id:'me', name:'Me', admin:false };
      DB.users[ME.id] = DB.users[ME.id] || { name: ME.name, email: 'me@example.com' };
    }
    // Ay seçimleri varsa render et
    if (document.getElementById('avail-month'))  renderMyCalendar();
    if (document.getElementById('team-month'))   renderTeamCalendar();
    setStatus('Connected', '#4CAF50');
  } catch (e) {
    console.error(e);
    setStatus('Connection Error', '#f44336');
  }
});
</script>
