<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Team Availability System</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
.container{max-width:1200px;margin:0 auto;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden}
.header{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;padding:20px;text-align:center;position:relative}
.status{position:absolute;top:10px;left:10px;padding:5px 10px;background:rgba(255,255,255,.2);border-radius:15px;font-size:.8rem}
.tabs{display:flex;background:#f5f5f5;border-bottom:2px solid #ddd}
.tab{flex:1;padding:15px;text-align:center;cursor:pointer;border:none;background:#f5f5f5;font-weight:600}
.tab.active{background:#fff;border-bottom:3px solid #4facfe}
.tab:disabled{opacity:.5;cursor:not-allowed}
.content{padding:30px}
.section{background:#f9f9f9;padding:20px;border-radius:8px;margin-bottom:20px;border-left:4px solid #4facfe}
.form-group{margin-bottom:15px}
.form-group label{display:block;margin-bottom:5px;font-weight:600}
.form-group input,.form-group select{width:100%;padding:10px;border:2px solid #ddd;border-radius:5px;font-size:1rem}
.btn{background:#4facfe;color:#fff;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-size:1rem;font-weight:600}
.btn:hover{background:#3a8bd9}
.btn-small{padding:6px 12px;font-size:.9rem}
.btn-danger{background:#dc3545}.btn-danger:hover{background:#c82333}
.msg{padding:15px;border-radius:5px;margin:15px 0}
.msg.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.msg.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.user-card{background:#fff;padding:15px;margin:10px 0;border-radius:5px;border:1px solid #ddd;display:flex;justify-content:space-between;align-items:center}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-top:20px}
.cal-day{padding:10px;border:2px solid #ddd;border-radius:5px;text-align:center;cursor:pointer;min-height:60px}
.cal-day.weekend{background:#f0f0f0;opacity:.5;cursor:not-allowed}
.cal-day.selected{background:#4facfe;color:#fff;border-color:#4facfe}
.cal-day.has-data{background:#d4edda}
.cal-day small{display:block;font-size:.75rem;margin-top:5px;line-height:1.1}
.time-picker{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin-top:10px}
.time-btn{padding:8px;border:2px solid #ddd;border-radius:5px;background:#fff;cursor:pointer;text-align:center}
.time-btn.selected{background:#4facfe;color:#fff;border-color:#4facfe}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{padding:10px;border:1px solid #ddd;text-align:center;vertical-align:top}
th{background:#4facfe;color:#fff}
.avail-yes{background:#d4edda}
.avail-no{background:#f8d7da}
.avail-unknown{background:#fff3cd}
.loading{text-align:center;padding:40px;color:#666}
/* çok satır kontrollü görünüm */
.slotlist{display:block;max-height:3.2em;overflow:hidden}
.more-link{display:inline-block;margin-top:4px;font-size:.75rem;text-decoration:underline;cursor:pointer;color:#0b5ed7}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="status" id="status">Connecting...</div>
    <h1>Team Availability System</h1>
    <p>Powered by GitHub + Netlify</p>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="showTab('login')" id="tab-login">Login</button>
    <button class="tab" onclick="showTab('admin')" id="tab-admin" disabled style="display:none;">Admin</button>
    <button class="tab" onclick="showTab('my-avail')" id="tab-my-avail" disabled>My Availability</button>
    <button class="tab" onclick="showTab('team')" id="tab-team" disabled>Team Calendar</button>
    <button class="tab" onclick="showTab('meeting')" id="tab-meeting" disabled>Plan Meeting</button>
  </div>

  <div class="content">
    <!-- LOGIN -->
    <div id="login" class="tab-content">
      <div class="section">
        <h3>Login</h3>
        <div class="form-group"><label>Email</label><input type="email" id="login-email"></div>
        <div class="form-group"><label>Password</label><input type="password" id="login-pwd"></div>
        <button class="btn" onclick="doLogin()">Login</button>
        <div id="login-msg"></div>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="admin" class="tab-content" style="display:none;">
      <h2>Admin Panel</h2>
      <button class="btn btn-small" onclick="doLogout()" style="float:right;">Logout</button>
      <div class="section">
        <h3>Add New User</h3>
        <div class="form-group"><label>Name</label><input type="text" id="new-name"></div>
        <div class="form-group"><label>Email</label><input type="email" id="new-email"></div>
        <div class="form-group"><label>Role</label><input type="text" id="new-role" placeholder="Developer, Designer, etc."></div>
        <button class="btn" onclick="addNewUser()">Add User</button>
        <div id="admin-msg"></div>
      </div>
      <div class="section">
        <h3>All Users</h3>
        <div id="users-list"></div>
      </div>
    </div>

    <!-- MY AVAILABILITY -->
    <div id="my-avail" class="tab-content" style="display:none;">
      <h2 id="avail-welcome">My Availability</h2>
      <button class="btn btn-small" onclick="doLogout()" style="float:right;">Logout</button>
      <div class="section">
        <label>Select Month:</label>
        <select id="avail-month" onchange="renderMyCalendar()"></select>
        <div id="my-calendar"></div>
      </div>
      <div class="section" id="time-section" style="display:none;">
        <h3>Set Time for Selected Days (<span id="selected-count">0</span> days selected)</h3>
        <div class="form-group">
          <label>Status</label>
          <select id="avail-status" onchange="toggleTimeInputs()">
            <option value="yes">Available</option>
            <option value="no">Not Available</option>
          </select>
        </div>
        <div id="time-inputs">
          <div class="form-group">
            <label>Start Time</label>
            <div class="time-picker" id="start-times"></div>
          </div>
          <div class="form-group">
            <label>End Time</label>
            <div class="time-picker" id="end-times"></div>
          </div>
        </div>
        <button class="btn" onclick="saveMyAvailability()">Save for Selected Days</button>
        <div id="avail-msg"></div>
        <p style="font-size:.85rem;color:#555;margin-top:8px;">
          İpucu: Aynı güne birden fazla aralık eklemek için <strong>aynı gün(leri)</strong> seçip farklı saatlerle <em>yeniden kaydedin</em>.
        </p>
      </div>
    </div>

    <!-- TEAM -->
    <div id="team" class="tab-content" style="display:none;">
      <h2>Team Calendar</h2>
      <div class="section">
        <label>Select Month:</label>
        <select id="team-month"></select>
        <button class="btn" onclick="renderTeamCalendar()">Load Calendar</button>
        <div id="team-calendar"></div>
      </div>
    </div>

    <!-- MEETING -->
    <div id="meeting" class="tab-content" style="display:none;">
      <h2>Plan Meeting</h2>
      <div class="section">
        <div class="form-group"><label>Select Month</label><select id="meeting-month"></select></div>
        <div class="form-group"><label>Meeting Duration (hours)</label><input type="number" id="meeting-duration" value="1" min="0.5" step="0.5"></div>
        <div class="form-group"><label>Select Participants (excluding admins)</label><div id="participants"></div></div>
        <button class="btn" onclick="findMeetingTimes()">Find Available Times</button>
        <div id="meeting-results"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ===== GLOBAL =====
let DB={users:{},availability:{}};
let ME=null;
let SELECTED_DAYS=new Set();
let START_TIME='09:00',END_TIME='17:00';
const API_URL='/.netlify/functions/github-proxy';
const VIEWER_TZ=Intl.DateTimeFormat().resolvedOptions().timeZone;

// ===== UTILS =====
function setStatus(t,c='#4CAF50'){const s=document.getElementById('status');s.textContent=t;s.style.background=c;}
function showMsg(id,txt,type){document.getElementById(id).innerHTML=`<div class="msg ${type}">${txt}</div>`;setTimeout(()=>document.getElementById(id).innerHTML='',5000);}
function showTab(name){document.querySelectorAll('.tab-content').forEach(el=>el.style.display='none');document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));document.getElementById(name).style.display='block';document.getElementById('tab-'+name).classList.add('active');if(name==='meeting')loadParticipants();}

// “+N daha” için yardımcılar
function renderSlotListHTML(slots, tz, maxLines=2){
  // slots: [{startUTC,endUTC,start?,end?}]
  const lines=slots.map(s=>{
    const sLbl=s.startUTC?new Date(s.startUTC).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',timeZone:tz}):(s.start||'');
    const eLbl=s.endUTC?new Date(s.endUTC).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',timeZone:tz}):(s.end||'');
    return `${sLbl}-${eLbl}`;
  });
  if(lines.length<=maxLines){
    return `<small class="slotlist">${lines.join('<br>')}</small>`;
  }
  const first=lines.slice(0,maxLines).join('<br>');
  const rest=lines.slice(maxLines).join('<br>');
  return `<small class="slotlist">${first}<span class="extra-slots" style="display:none"><br>${rest}</span></small>
          <a class="more-link" onclick="return showAllSlots(this)">+${lines.length-maxLines} daha</a>`;
}
function showAllSlots(a){
  const span=a.previousElementSibling.querySelector('.extra-slots');
  if(span){span.style.display='inline';}
  a.remove();
  return false;
}

// ===== API =====
async function apiCall(path,method='GET',data=null){
  const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path,method,data})});
  if(!r.ok){let t='';try{t=(await r.json()).error}catch{};throw new Error(t||'API request failed')}
  return await r.json();
}
async function loadDB(){
  try{
    const res=await apiCall('data.json');
    const json=decodeURIComponent(escape(atob(res.content)));
    DB=JSON.parse(json);
    DB.users=DB.users||{};
    DB.availability=DB.availability||{};
    return true;
  }catch(e){DB={users:{},availability:{}};return false;}
}
async function saveDB(){
  const content=btoa(unescape(encodeURIComponent(JSON.stringify(DB,null,2))));
  let sha=null;try{sha=(await apiCall('data.json')).sha}catch(e){}
  await apiCall('data.json','PUT',{message:'Update availability data',content,sha});
}

// ===== AUTH =====
async function hashPwd(p){const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(p));return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}
function genPwd(){const cs='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';let p='';for(let i=0;i<12;i++)p+=cs[Math.floor(Math.random()*cs.length)];return p;}
async function doLogin(){
  const email=document.getElementById('login-email').value.trim().toLowerCase();
  const pwd=document.getElementById('login-pwd').value;
  if(!email||!pwd){showMsg('login-msg','Fill both fields','error');return;}
  setStatus('Logging in...','#ff9800');
  try{
    await loadDB();const hash=await hashPwd(pwd);
    const found=Object.entries(DB.users).find(([id,u])=>u.email===email&&u.pwd===hash);
    if(!found){showMsg('login-msg','Invalid email or password','error');setStatus('Login Failed','#f44336');return;}
    ME={id:found[0],...found[1]};
    const tz=VIEWER_TZ;if(ME&&tz&&DB.users[ME.id]?.tz!==tz){DB.users[ME.id].tz=tz;await saveDB();}
    localStorage.setItem('current-user',JSON.stringify(ME));
    setStatus('Logged in as '+ME.name);
    document.getElementById('tab-my-avail').disabled=false;
    document.getElementById('tab-team').disabled=false;
    document.getElementById('tab-meeting').disabled=false;
    if(ME.admin){document.getElementById('tab-admin').style.display='block';document.getElementById('tab-admin').disabled=false;showTab('admin');refreshUsersList();}
    else{showTab('my-avail');setupAvailabilityTab();}
    populateMonthSelects();
  }catch(e){showMsg('login-msg','Error: '+e.message,'error');setStatus('Error','#f44336');}
}
function doLogout(){localStorage.removeItem('current-user');ME=null;document.getElementById('tab-my-avail').disabled=true;document.getElementById('tab-team').disabled=true;document.getElementById('tab-meeting').disabled=true;document.getElementById('tab-admin').style.display='none';setStatus('Logged out','#ff9800');showTab('login');}

// ===== ADMIN =====
async function addNewUser(){const name=document.getElementById('new-name').value.trim();const email=document.getElementById('new-email').value.trim().toLowerCase();const role=document.getElementById('new-role').value.trim();if(!name||!email||!role){showMsg('admin-msg','Fill all fields','error');return;}await loadDB();if(Object.values(DB.users).some(u=>u.email===email)){showMsg('admin-msg','Email already exists','error');return;}try{const pwd=genPwd();const hash=await hashPwd(pwd);const id='user_'+Date.now();DB.users[id]={name,email,role,pwd:hash,admin:false};await saveDB();alert(`User Created!\n\nName: ${name}\nEmail: ${email}\nPassword: ${pwd}\n\nShare this password securely!`);document.getElementById('new-name').value='';document.getElementById('new-email').value='';document.getElementById('new-role').value='';refreshUsersList();showMsg('admin-msg','User added successfully','success');}catch(e){showMsg('admin-msg','Error: '+e.message,'error');}}
async function refreshUsersList(){await loadDB();const list=Object.entries(DB.users);document.getElementById('users-list').innerHTML=list.length?list.map(([id,u])=>`<div class="user-card"><div><strong>${u.name}</strong> ${u.admin?'(Admin)':''}<br><small>${u.email} | ${u.role||'N/A'} ${u.tz?' | '+u.tz:''}</small></div><div><button class="btn btn-small" onclick="resetUserPwd('${id}')">Reset Password</button><button class="btn btn-small btn-danger" onclick="deleteUser('${id}')">Delete</button></div></div>`).join(''):'<p>No users yet</p>';}
async function resetUserPwd(id){await loadDB();const pwd=genPwd();const hash=await hashPwd(pwd);DB.users[id].pwd=hash;await saveDB();alert(`Password Reset!\n\nUser: ${DB.users[id].name}\nEmail: ${DB.users[id].email}\nNew Password: ${pwd}`);}
async function deleteUser(id){if(!confirm('Delete this user permanently?'))return;await loadDB();delete DB.users[id];if(DB.availability[id])delete DB.availability[id];await saveDB();refreshUsersList();}

// ===== AVAILABILITY =====
// (Kasım atlama düzeltmesi + seçim koruma)
function populateMonthSelects(){
  const selects=[document.getElementById('avail-month'),document.getElementById('team-month'),document.getElementById('meeting-month')];
  const keep=selects.map(s=>s?s.value:null);
  const months=[];const start=new Date(new Date().getFullYear(),new Date().getMonth(),1);
  for(let i=0;i<12;i++){const d=new Date(start.getFullYear(),start.getMonth()+i,1);const val=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;const txt=d.toLocaleDateString('en-US',{month:'long',year:'numeric'});months.push(`<option value="${val}">${txt}</option>`);}
  const html=months.join('');selects.forEach(s=>{if(s)s.innerHTML=html;});keep.forEach((v,i)=>{if(v&&selects[i])selects[i].value=v;});
}
function setupAvailabilityTab(){document.getElementById('avail-welcome').textContent=`Welcome ${ME.name}`;populateMonthSelects();renderMyCalendar();generateTimePickers();}
function toISO(dateStr,time){return new Date(`${dateStr}T${time}:00`).toISOString();}

function normalizeDayRecord(rec){
  // Geri uyumluluk
  if(!rec) return {slots:[]};
  if(Array.isArray(rec.slots)) return rec;
  const slots=[];
  if(rec.status==='yes' && (rec.startUTC||rec.start)){
    slots.push({start:rec.start||null,end:rec.end||null,startUTC:rec.startUTC||null,endUTC:rec.endUTC||null});
  }
  return {tz:rec.tz,slots};
}

async function renderMyCalendar(){
  await loadDB();
  const val=document.getElementById('avail-month').value;
  const [year,month]=val.split('-').map(Number);
  const firstDay=new Date(year,month-1,1);
  const lastDay=new Date(year,month,0);
  const days=lastDay.getDate();
  const startDow=(firstDay.getDay()+6)%7;

  let html='<div class="cal-grid">';
  ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=>{html+=`<div style="font-weight:bold;padding:10px;text-align:center;">${d}</div>`;});
  for(let i=0;i<startDow;i++) html+='<div></div>';

  const myAll=DB.availability[ME.id]||{};
  for(let d=1;d<=days;d++){
    const date=new Date(year,month-1,d);
    const dateStr=date.toISOString().split('T')[0];
    const dow=date.getDay();const isWeekend=dow===0||dow===6;
    let cls='cal-day',extra='';
    if(isWeekend) cls+=' weekend';
    else{
      const rec=normalizeDayRecord(myAll[dateStr]);
      if(rec.slots && rec.slots.length){
        cls+=' has-data';
        extra=renderSlotListHTML(rec.slots, VIEWER_TZ, 2);
      }
    }
    html+=`<div class="${cls}" data-date="${dateStr}" onclick="toggleDaySelection('${dateStr}', ${isWeekend})">${d}${extra}</div>`;
  }
  html+='</div>';
  document.getElementById('my-calendar').innerHTML=html;
  SELECTED_DAYS.clear();document.getElementById('time-section').style.display='none';
}

function toggleDaySelection(dateStr,isWeekend){
  if(isWeekend) return;
  const el=document.querySelector(`.cal-day[data-date="${dateStr}"]`);
  if(SELECTED_DAYS.has(dateStr)){SELECTED_DAYS.delete(dateStr);el.classList.remove('selected');}
  else{SELECTED_DAYS.add(dateStr);el.classList.add('selected');}
  document.getElementById('selected-count').textContent=SELECTED_DAYS.size;
  document.getElementById('time-section').style.display=SELECTED_DAYS.size?'block':'none';
  if(SELECTED_DAYS.size) generateTimePickers();
}

function generateTimePickers(){
  const times=[];for(let h=0;h<24;h++)for(let m=0;m<60;m+=30)times.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
  const work=times.slice(18,40);
  document.getElementById('start-times').innerHTML=work.map(t=>`<div class="time-btn ${t===START_TIME?'selected':''}" onclick="selectStartTime('${t}')">${t}</div>`).join('');
  document.getElementById('end-times').innerHTML=work.map(t=>`<div class="time-btn ${t===END_TIME?'selected':''}" onclick="selectEndTime('${t}')">${t}</div>`).join('');
}
function selectStartTime(t){START_TIME=t;generateTimePickers();}
function selectEndTime(t){END_TIME=t;generateTimePickers();}
function toggleTimeInputs(){document.getElementById('time-inputs').style.display=document.getElementById('avail-status').value==='yes'?'block':'none';}

async function saveMyAvailability(){
  if(SELECTED_DAYS.size===0){showMsg('avail-msg','Select at least one day','error');return;}
  await loadDB();
  const status=document.getElementById('avail-status').value;
  if(!DB.availability[ME.id]) DB.availability[ME.id]={};
  const myTZ=(DB.users[ME.id]&&DB.users[ME.id].tz)?DB.users[ME.id].tz:VIEWER_TZ;

  SELECTED_DAYS.forEach(dateStr=>{
    const current=normalizeDayRecord(DB.availability[ME.id][dateStr]);
    if(status==='no'){
      DB.availability[ME.id][dateStr]={tz:myTZ,slots:[]}; // günü temizle
    }else{
      const sISO=new Date(`${dateStr}T${START_TIME}:00`).toISOString();
      const eISO=new Date(`${dateStr}T${END_TIME}:00`).toISOString();
      current.tz=myTZ;
      current.slots=current.slots||[];
      current.slots.push({start:START_TIME,end:END_TIME,startUTC:sISO,endUTC:eISO});
      DB.availability[ME.id][dateStr]=current;
    }
  });

  try{
    setStatus('Saving...','#ff9800');await saveDB();
    setStatus('Saved!');showMsg('avail-msg',`Saved ${SELECTED_DAYS.size} day(s)!`,'success');renderMyCalendar();
  }catch(e){showMsg('avail-msg','Error: '+e.message,'error');setStatus('Save Failed','#f44336');}
}

// ===== TEAM CALENDAR =====
async function renderTeamCalendar(){
  await loadDB();
  const val=document.getElementById('team-month').value;
  const [year,month]=val.split('-').map(Number);
  const lastDay=new Date(year,month,0).getDate();

  const users=Object.entries(DB.users).filter(([id,u])=>!u.admin);
  if(!users.length){document.getElementById('team-calendar').innerHTML='<p>No users found</p>';return;}

  let html='<table><thead><tr><th>User</th>';
  for(let d=1;d<=lastDay;d++){const date=new Date(year,month-1,d);if(date.getDay()>=1&&date.getDay()<=5)html+=`<th>${d}</th>`;}
  html+='</tr></thead><tbody>';

  users.forEach(([uid,u])=>{
    html+=`<tr><td><strong>${u.name}</strong><br><small>${u.role||''}${u.tz?' • '+u.tz:''}</small></td>`;
    const userAvail=DB.availability[uid]||{};
    for(let d=1;d<=lastDay;d++){
      const date=new Date(year,month-1,d);
      if(date.getDay()>=1&&date.getDay()<=5){
        const dateStr=date.toISOString().split('T')[0];
        const rec=normalizeDayRecord(userAvail[dateStr]);
        let cls='avail-unknown',txt='-';
        if(rec){
          if(rec.slots && rec.slots.length){
            cls='avail-yes';
            const tz=u.tz||rec.tz||VIEWER_TZ;
            txt='✓<br>'+renderSlotListHTML(rec.slots, tz, 2);
          } else {
            cls='avail-no';txt='✗';
          }
        }
        html+=`<td class="${cls}">${txt}</td>`;
      }
    }
    html+='</tr>';
  });

  html+='</tbody></table>';
  document.getElementById('team-calendar').innerHTML=html;
}

// ===== MEETING (çoklu aralık kesişimi) =====
async function loadParticipants(){
  await loadDB();
  const users=Object.entries(DB.users).filter(([id,u])=>!u.admin);
  document.getElementById('participants').innerHTML=users.length?users.map(([id,u])=>`<label style="display:block;padding:5px;"><input type="checkbox" value="${id}">${u.name} (${u.role||'N/A'})</label>`).join(''):'<p>No users</p>';
}

function intersectIntervals(a,b){
  const out=[];
  a.forEach(i=>{b.forEach(j=>{const s=Math.max(i.s,j.s),e=Math.min(i.e,j.e);if(e>s) out.push({s,e});});});
  return out;
}

async function findMeetingTimes(){
  await loadDB();
  const val=document.getElementById('meeting-month').value;
  const [year,month]=val.split('-').map(Number);
  const duration=parseFloat(document.getElementById('meeting-duration').value);
  const selectedIds=Array.from(document.querySelectorAll('#participants input:checked')).map(cb=>cb.value);
  if(selectedIds.length<2){showMsg('meeting-results','Select at least 2 participants','error');return;}

  const lastDay=new Date(year,month,0).getDate();
  const results=[];

  for(let d=1;d<=lastDay;d++){
    const date=new Date(year,month-1,d);
    if(date.getDay()<1 || date.getDay()>5) continue;
    const dateStr=date.toISOString().split('T')[0];

    let common=null;
    for(const id of selectedIds){
      const rec=normalizeDayRecord(DB.availability[id]?.[dateStr]);
      const slots=(rec.slots||[]).filter(s=>s.startUTC&&s.endUTC).map(s=>({s:Date.parse(s.startUTC),e:Date.parse(s.endUTC)}));
      if(!slots.length){common=[];break;}
      common = common===null ? slots : intersectIntervals(common, slots);
      if(!common.length) break;
    }
    if(!common || !common.length) continue;

    common.forEach(iv=>{
      const hours=(iv.e-iv.s)/3600000;
      if(hours>=duration){
        const startISO=new Date(iv.s).toISOString();
        const endISO=new Date(iv.e).toISOString();
        results.push({
          label:date.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'}),
          startISO,endISO,
          start:new Date(iv.s).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',timeZone:VIEWER_TZ}),
          end:new Date(iv.e).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',timeZone:VIEWER_TZ}),
          hours
        });
      }
    });
  }

  if(!results.length){document.getElementById('meeting-results').innerHTML='<div class="msg error">No common times found</div>';return;}

  let html=`<div class="msg success">Found ${results.length} slot(s)</div>`;
  const idsNow=()=>Array.from(document.querySelectorAll('#participants input:checked')).map(cb=>cb.value).join(',');
  results.forEach(slot=>{
    html+=`<div class="section" style="background:#d4edda;border-color:#28a745;">
      <h4>${slot.label}</h4>
      <p><strong>Time:</strong> ${slot.start} - ${slot.end} (${slot.hours.toFixed(1)}h)</p>
      <button class="btn" onclick="createGoogleMeetISO('${slot.startISO}','${slot.endISO}','${idsNow()}')">Create Google Meet</button>
    </div>`;
  });
  document.getElementById('meeting-results').innerHTML=html;
}

function createGoogleMeetISO(startISO,endISO,participantIds){
  const emails=participantIds.split(',').map(id=>DB.users[id].email).join(',');
  const fmt=iso=>iso.replace(/[-:]/g,'').split('.')[0]+'Z';
  const url=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent('Team Meeting')}&dates=${fmt(startISO)}/${fmt(endISO)}&details=${encodeURIComponent('Scheduled via Team Availability System')}&add=${encodeURIComponent(emails)}`;
  window.open(url,'_blank');alert('Google Calendar opened!\n\n1. Click "Add Google Meet"\n2. Save event');
}

// ===== TZ AUTO-UPDATE =====
async function ensureUserTZ(){
  try{
    const current=Intl.DateTimeFormat().resolvedOptions().timeZone||'UTC';
    if(ME&&current&&DB&&DB.users&&DB.users[ME.id]&&DB.users[ME.id].tz!==current){
      await loadDB();DB.users[ME.id].tz=current;await saveDB();
      if(typeof renderTeamCalendar==='function') renderTeamCalendar();
      if(typeof renderMyCalendar==='function') renderMyCalendar();
      setStatus(`Timezone updated: ${current}`);
    }
  }catch(err){console.warn('ensureUserTZ error:',err);}
}
window.addEventListener('focus',ensureUserTZ);
setInterval(ensureUserTZ,15*60*1000);

// ===== INIT =====
window.addEventListener('DOMContentLoaded',async()=>{
  try{
    setStatus('Loading...','#ff9800');await loadDB();setStatus('Ready');
    const saved=localStorage.getItem('current-user');
    if(saved){
      ME=JSON.parse(saved);
      if(DB.users[ME.id]){
        document.getElementById('tab-my-avail').disabled=false;
        document.getElementById('tab-team').disabled=false;
        document.getElementById('tab-meeting').disabled=false;
        if(ME.admin){document.getElementById('tab-admin').style.display='block';document.getElementById('tab-admin').disabled=false;showTab('admin');refreshUsersList();}
        else{showTab('my-avail');setupAvailabilityTab();}
        populateMonthSelects();loadParticipants();ensureUserTZ();
      }else{localStorage.removeItem('current-user');}
    }
  }catch(e){setStatus('Connection Error','#f44336');console.error('Init error:',e);}
});
</script>
</body>
</html>
