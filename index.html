<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Team Availability System</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Segoe UI,Arial,Helvetica,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto;background:#111827;border:1px solid #374151;border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .header{background:linear-gradient(135deg,#4facfe 0%,#764ba2 100%);padding:20px 24px;color:#fff;position:relative}
    .status{position:absolute;top:10px;left:10px;background:rgba(255,255,255,.22);color:#fff;padding:6px 12px;border-radius:14px;font-size:.8rem}
    .tabs{display:flex;background:#0b1020;border-bottom:1px solid #26324d}
    .tab{flex:1;padding:14px 10px;text-align:center;cursor:pointer;background:#0b1020;color:#cbd5e1;border:none;font-weight:600}
    .tab.active{background:#121a33}
    .tab:disabled{opacity:.4;cursor:not-allowed}
    .content{padding:18px}
    .section{background:#0b1020;border:1px solid #26324d;border-radius:12px;padding:14px;margin-bottom:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    label{font-size:.92rem;color:#cbd5e1}
    select,input[type="month"],input[type="number"]{background:#0f1a33;border:1px solid #2a3a61;color:#e2e8f0;border-radius:8px;padding:8px 10px}
    .btn{background:#3b82f6;border:none;color:#fff;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .msg{padding:10px;border-radius:8px;margin-top:10px;font-weight:600}
    .msg.success{background:#064e3b;color:#d1fae5;border:1px solid #065f46}
    .msg.error{background:#5b1a1a;color:#fee2e2;border:1px solid #b91c1c}
    /* Calendar */
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .cal-day{background:#0f1a33;border:1px solid #26324d;border-radius:10px;min-height:84px;padding:8px;position:relative;cursor:pointer}
    .cal-day.selected{outline:2px solid #60a5fa}
    .cal-day.weekend{opacity:.45}
    .cal-day small{display:block;margin-top:6px;color:#93c5fd}
    .legend{display:flex;gap:10px;margin-top:8px}
    .dot{width:12px;height:12px;border-radius:50%}
    .has-data{outline:1px solid #334155}
    /* Team table */
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #26324d;padding:10px;text-align:left}
    th{color:#93c5fd}
    .avail-yes{background:#0d3d2f}
    .avail-no{background:#3b1d1d}
    .avail-unknown{background:#3b2e1d}
    .loading{padding:28px;text-align:center;color:#94a3b8}
    .time-btn{display:inline-block;border:1px solid #2a3a61;border-radius:8px;padding:6px 10px;margin:4px;cursor:pointer;background:#0f1a33}
    .time-btn.selected{outline:2px solid #60a5fa}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="status" id="status">Connecting...</div>
    <h1>Team Availability System</h1>
    <p>Powered by GitHub + Netlify</p>
  </div>

  <div class="tabs">
    <button id="tab-my-avail"  class="tab active" onclick="showTab('my-avail')">My Availability</button>
    <button id="tab-team"      class="tab" onclick="showTab('team')">Team</button>
    <button id="tab-meeting"   class="tab" onclick="showTab('meeting')">Meeting Planner</button>
    <button id="tab-admin"     class="tab" onclick="showTab('admin')" style="display:none">Admin</button>
  </div>

  <div class="content">
    <!-- MY AVAILABILITY -->
    <div id="my-avail" class="tab-content" style="display:block">
      <div class="section row">
        <label>Month:
          <input type="month" id="avail-month" onchange="renderMyCalendar()">
        </label>
        <label>Status:
          <select id="avail-status" onchange="toggleTimeInputs()">
            <option value="yes">Available</option>
            <option value="no">Not Available</option>
            <option value="clear">Clear (remove)</option>
          </select>
        </label>
        <div id="time-inputs" class="row" style="display:block">
          <div>
            <div style="margin-bottom:4px">Start</div>
            <div id="start-times"></div>
          </div>
          <div>
            <div style="margin-bottom:4px">End</div>
            <div id="end-times"></div>
          </div>
        </div>
        <button class="btn" onclick="saveMyAvailability()">Save</button>
      </div>
      <div id="avail-msg"></div>
      <div class="section">
        <div id="my-calendar" class="loading">Loading…</div>
        <div class="legend">
          <div class="dot" style="background:#0d3d2f"></div><span>Available</span>
          <div class="dot" style="background:#3b1d1d"></div><span>Not Available</span>
          <div class="dot" style="background:#3b2e1d"></div><span>Unknown</span>
        </div>
      </div>
    </div>

    <!-- TEAM -->
    <div id="team" class="tab-content" style="display:none">
      <div class="section row">
        <label>Month:
          <input type="month" id="team-month" onchange="renderTeamCalendar()">
        </label>
      </div>
      <div id="team-calendar" class="loading">Loading…</div>
    </div>

    <!-- MEETING PLANNER -->
    <div id="meeting" class="tab-content" style="display:none">
      <div class="section row">
        <label>Month:
          <input type="month" id="meeting-month">
        </label>
        <label>Duration (h):
          <input type="number" id="meeting-duration" step="0.5" min="0.5" value="1"/>
        </label>
        <button class="btn" onclick="findMeetingTimes()">Find Common Slots</button>
      </div>
      <div class="section">
        <h3>Participants</h3>
        <div id="participants" style="columns:2; gap:18px;"></div>
      </div>
      <div id="meeting-results" class="section">Select participants and search.</div>
    </div>

    <!-- ADMIN -->
    <div id="admin" class="tab-content" style="display:none">
      <div class="section">
        <h3>Users</h3>
        <div id="admin-users"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
      GLOBAL STATE
========================= */
let DB = { users: {}, availability: {} };
let ME = null;
let SELECTED_DAYS = new Set();
let START_TIME = '09:00';
let END_TIME   = '17:00';

// TIMEZONE HELPERS (canonical UTC storage + local display)
const VIEWER_TZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
function toUTCDateKeyFromLocalStr(s){ return new Date(`${s}T00:00:00`).toISOString().split('T')[0]; }
function toUTCDateKey(date){
  const y = date.getFullYear();
  const m = String(date.getMonth()+1).padStart(2,'0');
  const d = String(date.getDate()).padStart(2,'0');
  return new Date(`${y}-${m}-${d}T00:00:00`).toISOString().split('T')[0];
}

// NETLIFY FUNCTION ENDPOINT (varsa kullanır, yoksa localStorage fallback)
const API_URL = '/.netlify/functions/github-proxy';

/* =========================
      UTILITIES
========================= */
function log(...a){ console.log('[TeamAVAS]', ...a); }
function setStatus(txt,color){ const el=document.getElementById('status'); el.textContent=txt; if(color) el.style.background=color; }
function showMsg(id, txt, type){ document.getElementById(id).innerHTML = `<div class="msg ${type}">${txt}</div>`; setTimeout(()=>{ document.getElementById(id).innerHTML=''; }, 4000); }
function showTab(name){
  document.querySelectorAll('.tab-content').forEach(el=>el.style.display='none');
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
  document.getElementById(name).style.display='block';
  document.getElementById('tab-'+name).classList.add('active');
  if (name === 'meeting') loadParticipants();
}
function byId(id){ return document.getElementById(id); }

/* =========================
      API (fallback ile)
========================= */
async function apiCall(path, method='GET', data=null){
  try{
    const resp = await fetch(API_URL + path, {
      method,
      headers: {'Content-Type':'application/json'},
      body: data ? JSON.stringify(data) : null
    });
    if(!resp.ok) throw new Error(await resp.text());
    return await resp.json();
  }catch(e){
    // fallback localStorage
    log('apiCall failed; using localStorage fallback:', e.message);
    if(path==='/db' && method==='GET'){
      const raw = localStorage.getItem('teamavas-db');
      return raw ? JSON.parse(raw) : { users:{}, availability:{} };
    }
    if(path==='/db' && method==='PUT' && data){
      localStorage.setItem('teamavas-db', JSON.stringify(data));
      return { ok:true };
    }
    throw e;
  }
}
async function loadDB(){
  const data = await apiCall('/db','GET');
  DB = data || { users:{}, availability:{} };
  if(!DB.users) DB.users = {};
  if(!DB.availability) DB.availability = {};
}
async function saveDB(){ return apiCall('/db','PUT', DB); }

/* =========================
      AUTH (demo)
========================= */
function ensureMe(){
  // Demo amaçlı; gerçek uygulamada kimlik doğrulama bağlanır
  const stored = JSON.parse(localStorage.getItem('current-user') || 'null');
  if(stored){ return stored; }
  // Varsayılan bir kullanıcı aç
  const demo = { id:'me', name:'You', email:'you@example.com', tz:VIEWER_TZ, admin:true };
  localStorage.setItem('current-user', JSON.stringify(demo));
  return demo;
}

/* =========================
      MY AVAILABILITY UI
========================= */
function toggleDaySelection(dateStr, isWeekend){
  if(isWeekend) return;
  const dayEl = document.querySelector(`.cal-day[data-date="${dateStr}"]`);
  if(!dayEl) return;
  if(SELECTED_DAYS.has(dateStr)){ SELECTED_DAYS.delete(dateStr); dayEl.classList.remove('selected'); }
  else { SELECTED_DAYS.add(dateStr); dayEl.classList.add('selected'); }
  document.getElementById('time-section')?.scrollIntoView({behavior:'smooth', block:'start'});
}
function toggleTimeInputs(){
  document.getElementById('time-inputs').style.display =
    document.getElementById('avail-status').value === 'yes' ? 'block' : 'none';
}
function generateTimePickers(){
  const workTimes = [];
  for (let h=6; h<=22; h++){
    for (let m of [0,30]){
      workTimes.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
    }
  }
  byId('start-times').innerHTML = workTimes.map(t =>
    `<div class="time-btn ${t===START_TIME?'selected':''}" onclick="selectStartTime('${t}')">${t}</div>`
  ).join('');
  byId('end-times').innerHTML = workTimes.map(t =>
    `<div class="time-btn ${t===END_TIME?'selected':''}" onclick="selectEndTime('${t}')">${t}</div>`
  ).join('');
}
function selectStartTime(t){ START_TIME=t; generateTimePickers(); }
function selectEndTime(t){ END_TIME=t; generateTimePickers(); }

async function renderMyCalendar(){
  await loadDB();
  const val = byId('avail-month').value;
  const [year, month] = val.split('-').map(Number);
  const firstDay = new Date(year, month-1, 1);
  const lastDay  = new Date(year, month, 0);
  const daysInMonth = lastDay.getDate();
  const startDow = (firstDay.getDay() + 6) % 7;

  const myAvail = DB.availability[ME.id] || {};
  let html = '<div class="cal-grid">';
  ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=> html+=`<div style="font-weight:bold;padding:10px;text-align:center">${d}</div>`);

  for(let i=0;i<startDow;i++){ html+=`<div></div>`; }

  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(year, month-1, d);
    const dow = date.getDay();
    const isWeekend = (dow===0 || dow===6);
    const dateStrLocal = date.toISOString().split('T')[0];
    const dateKeyUTC = toUTCDateKeyFromLocalStr(dateStrLocal);
    let cls = 'cal-day' + (isWeekend?' weekend':'');
    let extra = '';

    if(!isWeekend && myAvail[dateKeyUTC]){
      cls += ' has-data';
      const av = myAvail[dateKeyUTC];
      const startLabel = av.startUTC ? new Date(av.startUTC).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : (av.start || '');
      const endLabel   = av.endUTC   ? new Date(av.endUTC).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : (av.end || '');
      extra = av.status==='yes' ? `<small>${startLabel}-${endLabel}</small>` : '<small>Not Available</small>';
    }
    html += `<div class="${cls}" data-date="${dateStrLocal}" onclick="toggleDaySelection('${dateStrLocal}',${isWeekend})">
      <div style="opacity:.8">${d}</div>${extra}
    </div>`;
  }
  html += '</div>';
  byId('my-calendar').innerHTML = html;
}

async function saveMyAvailability(){
  if(SELECTED_DAYS.size===0){ showMsg('avail-msg','Select at least one day','error'); return; }
  await loadDB();
  const status = byId('avail-status').value;
  if(!DB.availability[ME.id]) DB.availability[ME.id] = {};

  SELECTED_DAYS.forEach(dateStrLocal=>{
    const dateKeyUTC = toUTCDateKeyFromLocalStr(dateStrLocal);
    if(status==='clear'){
      delete DB.availability[ME.id][dateKeyUTC];
      return;
    }
    const startLocal = new Date(`${dateStrLocal}T${START_TIME}:00`);
    const endLocal   = new Date(`${dateStrLocal}T${END_TIME}:00`);
    DB.availability[ME.id][dateKeyUTC] = {
      status,
      // legacy labels (UI etiketi için)
      start: status==='yes'? START_TIME : null,
      end:   status==='yes'? END_TIME   : null,
      // canonical UTC
      startUTC: status==='yes'? startLocal.toISOString() : null,
      endUTC:   status==='yes'? endLocal.toISOString()   : null,
      tz: VIEWER_TZ
    };
  });

  try{
    setStatus('Saving...','#ff9800');
    await saveDB();
    setStatus('Saved!','#4CAF50');
    showMsg('avail-msg', `Saved ${SELECTED_DAYS.size} days!`, 'success');
    renderMyCalendar();
  }catch(e){
    showMsg('avail-msg','Error: '+e.message,'error');
    setStatus('Save Failed','#f44336');
  }
}

/* =========================
      TEAM CALENDAR
========================= */
async function renderTeamCalendar(){
  await loadDB();
  const val = byId('team-month').value;
  const [year, month] = val.split('-').map(Number);
  const lastDay = new Date(year, month, 0);
  const daysInMonth = lastDay.getDate();

  const users = Object.entries(DB.users).length ? Object.entries(DB.users) : Object.entries({
    me: {name: 'You', email:'you@example.com', tz: VIEWER_TZ, admin: true}
  }).filter(([id,u])=>!u.admin);

  if(users.length===0){ byId('team-calendar').innerHTML='<p>No users found</p>'; return; }

  let html = '<table><thead><tr><th>User</th>';
  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(year, month-1, d);
    if(date.getDay()>=1 && date.getDay()<=5){
      html += `<th>${d}</th>`;
    }
  }
  html += '</tr></thead><tbody>';

  users.forEach(([id,u])=>{
    html += `<tr><td>${u.name || id}</td>`;
    const userAvail = DB.availability[id] || {};
    for(let d=1; d<=daysInMonth; d++){
      const date = new Date(year, month-1, d);
      if(date.getDay()>=1 && date.getDay()<=5){
        const dateStrLocal = date.toISOString().split('T')[0];
        const dateKeyUTC   = toUTCDateKeyFromLocalStr(dateStrLocal);
        const av = userAvail[dateKeyUTC];
        let cls='avail-unknown', txt='-';
        if(av){
          cls = av.status==='yes' ? 'avail-yes':'avail-no';
          const startLabel = av.startUTC ? new Date(av.startUTC).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : (av.start || '');
          const endLabel   = av.endUTC   ? new Date(av.endUTC).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})   : (av.end || '');
          txt = av.status==='yes' ? `✓<br><small>${startLabel}-${endLabel}</small>` : '✗';
        }
        html += `<td class="${cls}">${txt}</td>`;
      }
    }
    html += '</tr>';
  });

  html += '</tbody></table>';
  byId('team-calendar').innerHTML = html;
}

/* =========================
      MEETING PLANNER
========================= */
function populateMonthSelects(){
  const now = new Date();
  const ym  = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  ['avail-month','team-month','meeting-month'].forEach(id => { const el=byId(id); if(el) el.value = ym; });
}
function loadParticipants(){
  const entries = Object.entries(DB.users);
  const users = entries.length ? entries : Object.entries({
    me: {name:'You', email:'you@example.com', tz:VIEWER_TZ, admin:true}
  });
  byId('participants').innerHTML = users.map(([id,u]) =>
    `<label style="display:block;padding:5px;"><input type="checkbox" value="${id}">${u.name || id} (${u.role || 'N/A'})</label>`
  ).join('');
}

async function findMeetingTimes(){
  await loadDB();
  const val = byId('meeting-month').value;
  const [year, month] = val.split('-').map(Number);
  const duration = parseFloat(byId('meeting-duration').value);

  const selectedIds = Array.from(document.querySelectorAll('#participants input:checked')).map(cb=>cb.value);
  if(selectedIds.length < 2){ showMsg('meeting-results','Select at least 2 participants','error'); return; }

  const lastDay = new Date(year, month, 0);
  const commonSlots = [];

  for(let d=1; d<=lastDay.getDate(); d++){
    const date = new Date(year, month-1, d);
    if(date.getDay()>=1 && date.getDay()<=5){
      const dateStrLocal = date.toISOString().split('T')[0];
      const dateStr = toUTCDateKeyFromLocalStr(dateStrLocal);
      const allAvail = selectedIds.every(id => DB.availability[id]?.[dateStr]?.status === 'yes');
      if(allAvail){
        const slots = selectedIds.map(id=>{
          const av = DB.availability[id][dateStr];
          return {
            id,
            startISO: av.startUTC || (av.start ? new Date(`${dateStr}T${av.start}:00`).toISOString() : null),
            endISO:   av.endUTC   || (av.end   ? new Date(`${dateStr}T${av.end}:00`).toISOString()   : null),
            name: DB.users[id]?.name || id
          };
        });
        const latestStartISO = slots.reduce((max,s)=>(!max || (s.startISO && s.startISO > max)) ? s.startISO : max, null);
        const earliestEndISO = slots.reduce((min,s)=>(!min || (s.endISO && s.endISO < min)) ? s.endISO : min, null);
        const startMs = Date.parse(latestStartISO);
        const endMs   = Date.parse(earliestEndISO);
        const availHours = (endMs - startMs) / 3600000;

        if(availHours >= duration){
          commonSlots.push({
            date: dateStr,
            formatted: date.toLocaleDateString('tr-TR', { weekday:'long', month:'long', day:'numeric' }),
            startISO: latestStartISO,
            endISO: earliestEndISO,
            start: new Date(latestStartISO).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
            end:   new Date(earliestEndISO).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
            duration: availHours,
            participants: slots
          });
        }
      }
    }
  }

  if(commonSlots.length===0){
    byId('meeting-results').innerHTML = '<div class="msg error">No common slots found for the given month.</div>';
    return;
  }

  let html = '';
  commonSlots.forEach(slot=>{
    html += `<div class="section" style="background:#0d3d2f;border-color:#065f46">
      <h4>${slot.formatted}</h4>
      <p><strong>Time:</strong> ${slot.start} - ${slot.end} (${slot.duration.toFixed(1)}h)</p>
      <p><strong>Participants:</strong> ${slot.participants.map(p=>p.name).join(', ')}</p>
      <button class="btn" onclick="createGoogleMeetISO('${slot.startISO}','${slot.endISO}','${slot.participants.map(p=>p.id).join(',')}')">Create Google Meet</button>
    </div>`;
  });
  byId('meeting-results').innerHTML = html;
}

function createGoogleMeetISO(startISO, endISO, participantIds){
  const participantEmails = participantIds.split(',').map(id=> DB.users[id]?.email).filter(Boolean).join(',');
  const fmt = (iso)=> iso.replace(/[-:]/g,'').split('.')[0] + 'Z';
  const url = `https://calendar.google.com/calendar/render?action=TEMPLATE`
    + `&text=${encodeURIComponent('Team Meeting')}`
    + `&dates=${fmt(startISO)}/${fmt(endISO)}`
    + `&details=${encodeURIComponent('Scheduled via Team Availability System')}`
    + `&add=${encodeURIComponent(participantEmails)}`;
  window.open(url, '_blank');
  alert('Google Calendar opened!\n\n1) "Add Google Meet"e tıkla\n2) Kaydet');
}

/* =========================
      ADMIN (demo)
========================= */
function refreshUsersList(){
  const users = Object.entries(DB.users);
  if(users.length===0){
    byId('admin-users').innerHTML = '<p class="muted">No users (demo). Mevcut kullanıcı: You</p>';
    return;
  }
  byId('admin-users').innerHTML = '<ul>' + users.map(([id,u])=>`<li>${u.name} — ${u.email || ''}</li>`).join('') + '</ul>';
}

/* =========================
      INIT
========================= */
function setupAvailabilityTab(){
  // saat seçicileri çiz
  generateTimePickers();
  toggleTimeInputs();
  renderMyCalendar();
}
function initMonths(){
  populateMonthSelects();
  renderMyCalendar();
  renderTeamCalendar();
}

window.addEventListener('DOMContentLoaded', async ()=>{
  try{
    setStatus('Connecting...','#64748b');
    ME = ensureMe();
    await loadDB();
    if(!DB.users[ME.id]) DB.users[ME.id] = { name: ME.name, email: ME.email, tz: ME.tz, admin: !!ME.admin };
    await saveDB();

    // admin görünümü
    if(ME.admin){
      document.getElementById('tab-admin').style.display='block';
    }

    initMonths();
    setupAvailabilityTab();
    loadParticipants();
    refreshUsersList();
    setStatus(`Signed in as ${ME.name} (${VIEWER_TZ})`,'#334155');
  }catch(err){
    console.error(err);
    setStatus('Connection Error','#b91c1c');
  }
});
</script>
</body>
</html>
